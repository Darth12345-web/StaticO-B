<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>O&amp;B StarLauncher</title>
  <link href="https://fonts.googleapis.com/css2?family=Comfortaa:wght@300;400;700&display=swap" rel="stylesheet"/>
  <style>
    /* ============================================================
       THEME
       ============================================================ */
    :root{
      --blue-0:#061024;
      --blue-1:#0a183a;
      --blue-2:#0e224f;
      --blue-3:#123062;
      --blue-4:#174081;
      --blue-5:#1c4e9c;
      --accent:#67d1ff;
      --accent-2:#7fffd4;
      --accent-3:#b28aff;
      --text:#e7f0ff;
      --muted:#b9c7ff;
      --glass:rgba(255,255,255,.07);
      --glass-strong:rgba(255,255,255,.14);
      --radius:20px;
      --radius-sm:12px;
      --shadow-1:0 10px 20px rgba(0,0,0,.25);
      --shadow-2:0 18px 36px rgba(0,0,0,.32);
      --shadow-3:0 28px 58px rgba(0,0,0,.38);
      --shadow-4:0 40px 80px rgba(0,0,0,.44);
      --dur-fast:.28s;
      --dur:.46s;
      --dur-slow:.9s;
      --ease:cubic-bezier(.22,.61,.36,1);
      --bg-parallax:14;
      --bg-sat:112%;
      --bg-contrast:108%;
    }
    html,body{
      height:100%; margin:0; color:var(--text);
      font-family:'Comfortaa',system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;
      background:radial-gradient(1400px 900px at 24% 18%,var(--blue-4) 0%,var(--blue-2) 35%,var(--blue-1) 62%,var(--blue-0) 100%);
      overflow:hidden;
    }
    *{box-sizing:border-box;}
    ::selection{background:rgba(103,209,255,.35);color:#041224;}

    /* ============================================================
       BACKGROUND
       ============================================================ */
    .bg{position:fixed;inset:0;z-index:-3;pointer-events:none;}
    canvas#particles{position:absolute;inset:0;z-index:-1;}
    .bg-gradient{
      position:absolute;inset:0;z-index:-2;
      background:
        radial-gradient(1100px 820px at 12% 88%,rgba(103,209,255,.08),transparent 60%),
        radial-gradient(1000px 700px at 86% 12%,rgba(127,255,212,.06),transparent 60%);
      mix-blend-mode:screen;
    }
    .blobs{position:absolute;inset:0;z-index:-2;mix-blend-mode:screen;overflow:hidden;}
    .blob{
      position:absolute;width:440px;height:440px;border-radius:50%;
      filter:blur(46px);
      background:radial-gradient(circle at 30% 30%,rgba(103,209,255,.22),rgba(103,209,255,0) 60%);
      animation:blobFloat 24s var(--ease) infinite;
    }
    .blob.b2{width:560px;height:560px;background:radial-gradient(circle at 60% 40%,rgba(127,255,212,.18),rgba(127,255,212,0) 60%);animation-duration:28s;animation-delay:-6s;}
    .blob.b3{width:480px;height:480px;background:radial-gradient(circle at 40% 60%,rgba(178,138,255,.16),rgba(178,138,255,0) 60%);animation-duration:32s;animation-delay:-10s;}
    @keyframes blobFloat{
      0%{transform:translate(4vw,2vh);}25%{transform:translate(30vw,-6vh);}
      50%{transform:translate(62vw,8vh);}75%{transform:translate(40vw,18vh);}100%{transform:translate(4vw,2vh);}
    }
    .parallax{position:absolute;inset:0;z-index:-1;pointer-events:none;will-change:transform;transform:translate3d(0,0,0);}

    /* ============================================================
       APP
       ============================================================ */
    .app{position:relative;height:100%;overflow:auto;backdrop-filter:blur(8px);scroll-behavior:smooth;}
    .app::-webkit-scrollbar{width:12px;}
    .app::-webkit-scrollbar-thumb{background:linear-gradient(180deg,rgba(103,209,255,.35),rgba(127,255,212,.35));border-radius:12px;border:2px solid rgba(255,255,255,.18);}
    .app::-webkit-scrollbar-track{background:rgba(255,255,255,.06);border-radius:12px;}

    /* ============================================================
       HEADER ‚Äî fix.css merged
       ============================================================ */
    header.main-header{
      position:sticky;top:0;z-index:30;
      margin:20px auto 0;max-width:1240px;
      padding:14px 16px;border-radius:var(--radius);
      background:rgba(10,20,40,0.92);
      backdrop-filter:blur(12px);
      border:1px solid rgba(255,255,255,.12);
      box-shadow:0 8px 18px rgba(0,0,0,.35);
      display:flex;align-items:center;gap:14px;flex-wrap:wrap;
    }
    header.main-header .logo{
      width:52px;height:52px;border-radius:14px;flex-shrink:0;
      background:conic-gradient(from 120deg,var(--accent),var(--accent-2),var(--accent-3),var(--blue-4),var(--accent));
      box-shadow:0 8px 20px rgba(103,209,255,.25);
      animation:spinSoft 14s linear infinite;
    }
    @keyframes spinSoft{from{transform:rotate(0);}to{transform:rotate(360deg);}}
    header.main-header h1{margin:0;font-size:1.6rem;font-weight:700;letter-spacing:.4px;}
    header.main-header .spacer{flex:1;}
    .actions{display:flex;gap:10px;flex-wrap:wrap;align-items:center;}
    .control{
      display:flex;align-items:center;gap:10px;
      padding:8px 10px;border-radius:var(--radius-sm);
      background:var(--glass);border:1px solid rgba(255,255,255,.14);
      transition:background var(--dur) var(--ease),transform var(--dur) var(--ease),box-shadow var(--dur) var(--ease);
    }
    .control:focus-within{background:var(--glass-strong);transform:translateY(-1px);box-shadow:0 12px 30px rgba(0,0,0,.25);}
    .control input{
      flex:1;min-width:220px;padding:10px 12px;color:var(--text);
      background:transparent;border:0;outline:none;font-size:.98rem;font-family:inherit;
    }
    .control input::placeholder{color:rgba(185,199,255,.5);}
    .btn{
      padding:10px 14px;border:0;border-radius:12px;color:#041224;
      background:linear-gradient(180deg,var(--accent) 0%,#a0e7ff 100%);
      box-shadow:0 8px 18px rgba(103,209,255,.35);
      font-weight:700;cursor:pointer;font-family:inherit;font-size:.9rem;white-space:nowrap;
      transition:transform var(--dur-fast) var(--ease),box-shadow var(--dur-fast) var(--ease),filter var(--dur-fast) var(--ease);
    }
    .btn:hover{transform:translateY(-2px) scale(1.02);filter:brightness(1.05);}
    .btn:active{transform:translateY(0) scale(.98);box-shadow:0 6px 14px rgba(103,209,255,.28);}

    /* ============================================================
       NAV ‚Äî fix.css merged
       ============================================================ */
    .nav{
      margin:14px auto 0;max-width:1240px;padding:8px;border-radius:16px;
      display:flex;gap:8px;align-items:center;flex-wrap:wrap;
      background:rgba(15,25,50,0.9);
      backdrop-filter:blur(10px);
      border:1px solid rgba(255,255,255,.15);
      box-shadow:0 6px 14px rgba(0,0,0,.28);
    }
    .nav .pill{
      padding:8px 14px;border-radius:999px;
      background:rgba(255,255,255,.12);border:1px solid rgba(255,255,255,.18);
      cursor:pointer;transition:.25s var(--ease);font-size:.88rem;user-select:none;
    }
    .nav .pill:hover{transform:translateY(-1px);background:rgba(255,255,255,.18);}
    .nav .pill.active{background:linear-gradient(180deg,rgba(103,209,255,.35),rgba(127,255,212,.35));color:#041224;border-color:rgba(103,209,255,.5);}

    /* ============================================================
       CONTENT
       ============================================================ */
    .content{max-width:1240px;margin:14px auto 94px;padding:0 8px;}
    .toolbar{
      display:flex;gap:8px;align-items:center;flex-wrap:wrap;
      margin:0 0 12px;padding:10px;border-radius:var(--radius-sm);
      background:linear-gradient(180deg,rgba(255,255,255,.08),rgba(255,255,255,.04));
      border:1px solid rgba(255,255,255,.12);
    }
    .chip{
      padding:7px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.16);
      background:rgba(255,255,255,.08);cursor:pointer;transition:.25s var(--ease);
      font-size:.84rem;user-select:none;font-family:inherit;
    }
    .chip:hover{transform:translateY(-1px);background:rgba(255,255,255,.16);border-color:rgba(255,255,255,.28);}
    .chip:active{transform:translateY(0);}

    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:16px;}
    @media(max-width:1100px){.grid{grid-template-columns:repeat(8,1fr);}}
    @media(max-width:860px){.grid{grid-template-columns:repeat(6,1fr);}}
    @media(max-width:640px){.grid{grid-template-columns:repeat(2,1fr);}}

    /* ============================================================
       CARD
       ============================================================ */
    .card{
      grid-column:span 4;
      background:linear-gradient(180deg,rgba(255,255,255,.09),rgba(255,255,255,.03));
      border:1px solid rgba(255,255,255,.14);border-radius:var(--radius);
      box-shadow:var(--shadow-2);overflow:hidden;position:relative;
      display:flex;flex-direction:column;min-height:340px;transform:translateZ(0);
      transition:transform var(--dur) var(--ease),box-shadow var(--dur) var(--ease),border-color var(--dur) var(--ease);
    }
    .card:hover{transform:translateY(-3px);box-shadow:var(--shadow-4);border-color:rgba(255,255,255,.22);}

    /* Card's own header ‚Äî distinct from main header */
    .card-header{
      padding:10px 14px;
      background:linear-gradient(180deg,rgba(255,255,255,.082),rgba(255,255,255,.02));
      border-bottom:1px solid rgba(255,255,255,.12);
      display:flex;gap:10px;align-items:center;justify-content:space-between;
      flex-wrap:nowrap;
    }
    .title{display:flex;align-items:center;gap:10px;min-width:0;}
    .title .card-logo{
      width:36px;height:36px;border-radius:10px;flex-shrink:0;
      background:linear-gradient(135deg,var(--accent) 0%,var(--accent-2) 50%,var(--accent-3) 100%);
      box-shadow:0 6px 12px rgba(103,209,255,.25);
    }
    .title h2{margin:0;font-size:1rem;letter-spacing:.3px;font-weight:700;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:22ch;}
    .meta{color:var(--muted);font-size:.78rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:14ch;flex-shrink:0;}
    .select{display:flex;align-items:center;gap:5px;font-size:.82rem;color:var(--muted);cursor:pointer;user-select:none;flex-shrink:0;}
    .select input[type="checkbox"]{cursor:pointer;accent-color:var(--accent);}
    .game-thumb{ position:relative; width:100%; height:100%; overflow:hidden; }
    .game-thumb::after{ content:''; position:absolute; inset:0; background:linear-gradient(to bottom, transparent 40%, rgba(0,0,0,.7) 100%); pointer-events:none; }
    .thumb-play-btn{
      position:absolute; bottom:16px; left:50%; transform:translateX(-50%);
      padding:10px 28px; border-radius:999px; font-weight:700; font-size:.95rem;
      background:linear-gradient(135deg,var(--accent),var(--accent-2));
      color:#041224; z-index:2; box-shadow:0 6px 20px rgba(0,0,0,.5);
      transition:transform .18s, box-shadow .18s; white-space:nowrap;
      font-family:'Comfortaa',system-ui,sans-serif;
    }
    .game-thumb:hover .thumb-play-btn{ transform:translateX(-50%) scale(1.08); box-shadow:0 10px 28px rgba(0,0,0,.6); }
    .frame{
      position:relative;flex:1;min-height:260px;
      background:radial-gradient(540px 340px at 50% 50%,rgba(103,209,255,.06),rgba(255,255,255,0) 65%);
      display:flex;align-items:center;justify-content:center;overflow:hidden;
    }
    iframe{
      width:100%;height:100%;border:0;background:#081431;transform:scale(1) translateZ(0);
      transition:transform var(--dur-slow) var(--ease),filter var(--dur-slow) var(--ease);
    }
    .card:hover iframe{transform:scale(1.012);filter:saturate(114%);}
    .tools{display:flex;gap:5px;align-items:center;flex-shrink:0;}
    .btn-icon{
      width:32px;height:32px;border-radius:9px;border:1px solid rgba(255,255,255,.16);
      background:rgba(255,255,255,.08);display:grid;place-items:center;cursor:pointer;flex-shrink:0;
      transition:transform var(--dur-fast) var(--ease),background var(--dur-fast) var(--ease),border-color var(--dur-fast) var(--ease);
    }
    .btn-icon:hover{transform:translateY(-2px);background:rgba(255,255,255,.18);border-color:rgba(255,255,255,.3);}
    .btn-icon:active{transform:translateY(0) scale(.95);}
    .btn-icon svg{width:16px;height:16px;fill:var(--text);opacity:.9;}
    .card-actions{
      display:flex;gap:6px;align-items:center;padding:8px 12px;
      background:rgba(0,0,0,.3);border-top:1px solid rgba(255,255,255,.08);flex-wrap:wrap;
    }
    .act-btn{
      display:inline-flex;align-items:center;gap:5px;padding:7px 13px;border-radius:10px;
      border:1px solid rgba(255,255,255,.2);background:rgba(255,255,255,.1);
      color:var(--text);font-family:inherit;font-size:.8rem;font-weight:700;
      cursor:pointer;transition:.15s;white-space:nowrap;
    }
    .act-btn:hover{background:rgba(255,255,255,.22);transform:translateY(-1px);}
    .act-btn.play{background:linear-gradient(135deg,rgba(103,209,255,.35),rgba(127,255,212,.35));border-color:rgba(103,209,255,.6);color:#a8f0ff;}
    .act-btn.play:hover{background:linear-gradient(135deg,rgba(103,209,255,.55),rgba(127,255,212,.55));}
    .act-btn.fs{border-color:rgba(178,138,255,.4);color:#d4bcff;}
    .act-btn.newtab{border-color:rgba(255,255,255,.25);}
    .act-btn svg{width:13px;height:13px;fill:currentColor;}
    .ribbon{position:absolute;top:0;right:0;padding:5px 9px;font-weight:700;font-size:.7rem;background:linear-gradient(180deg,rgba(127,255,212,.85),rgba(103,209,255,.85));color:#041224;border-bottom-left-radius:10px;box-shadow:var(--shadow-1);letter-spacing:.08em;}
    .fav-tag{position:absolute;bottom:10px;right:10px;padding:5px 10px;border-radius:10px;font-weight:700;font-size:.72rem;background:linear-gradient(180deg,rgba(178,138,255,.9),rgba(127,255,212,.9));color:#041224;box-shadow:var(--shadow-1);display:none;}
    .card.favorited .fav-tag{display:block;}

    /* ============================================================
       EMPTY
       ============================================================ */
    .empty{
      grid-column:1/-1;display:flex;align-items:center;justify-content:center;text-align:center;
      padding:42px 20px;color:var(--muted);
      background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.03));
      border:1px dashed rgba(255,255,255,.18);border-radius:var(--radius);
      animation:floatIn var(--dur-slow) var(--ease) both;
    }
    @keyframes floatIn{from{opacity:0;transform:translateY(12px) scale(.98);}to{opacity:1;transform:translateY(0) scale(1);}}

    /* ============================================================
       FOOTER
       ============================================================ */
    .main-footer{
      max-width:1240px;margin:16px auto 110px;padding:16px 20px;border-radius:var(--radius);
      border:1px solid rgba(255,255,255,.12);
      background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.03));
      box-shadow:var(--shadow-2);font-size:.88rem;color:var(--muted);
    }
    .main-footer p{margin:0;}
    .main-footer strong{color:var(--text);}

    /* ============================================================
       TOAST
       ============================================================ */
    .toast{
      position:fixed;bottom:22px;left:50%;
      transform:translateX(-50%) translateY(20px);
      background:rgba(14,26,71,.92);color:var(--text);
      border:1px solid rgba(255,255,255,.18);border-radius:14px;
      padding:12px 18px;box-shadow:var(--shadow-4);
      opacity:0;pointer-events:none;white-space:nowrap;font-size:.9rem;
      transition:opacity var(--dur) var(--ease),transform var(--dur) var(--ease);z-index:80;
    }
    .toast.show{opacity:1;transform:translateX(-50%) translateY(0);}

    /* ============================================================
       PANEL
       ============================================================ */
    .panel{
      position:fixed;top:86px;right:18px;z-index:50;
      width:330px;max-width:calc(100vw - 24px);
      padding:14px;border-radius:16px;
      background:rgba(8,16,42,0.97);
      backdrop-filter:blur(16px);
      border:1px solid rgba(255,255,255,.16);box-shadow:var(--shadow-4);
    }
    .panel h3{margin:0 0 10px;font-size:1rem;color:var(--accent);}
    .row{display:flex;gap:10px;align-items:center;margin:7px 0;}
    .panel label{flex:1;font-size:.86rem;opacity:.85;}
    .panel select,.panel input[type="color"],.panel input[type="range"]{
      flex:1;appearance:none;padding:6px 8px;border-radius:10px;
      border:1px solid rgba(255,255,255,.16);background:rgba(255,255,255,.08);color:var(--text);font-family:inherit;
    }
    .panel select option{background:#0a183a;}
    .switch{display:flex;align-items:center;gap:8px;}
    .btns{display:flex;gap:8px;margin-top:10px;}

    /* ============================================================
       BATCH BAR
       ============================================================ */
    .batch{
      position:sticky;bottom:0;z-index:40;margin:0 auto;max-width:1240px;
      display:flex;gap:10px;align-items:center;justify-content:space-between;
      padding:10px 14px;border-radius:14px;
      background:rgba(8,16,42,0.96);backdrop-filter:blur(12px);
      border:1px solid rgba(255,255,255,.18);box-shadow:var(--shadow-3);
    }
    .batch .left,.batch .right{display:flex;gap:8px;align-items:center;flex-wrap:wrap;}

    /* ============================================================
       MODALS
       ============================================================ */
    .modal{position:fixed;inset:0;display:none;place-items:center;z-index:90;background:rgba(0,0,0,.55);backdrop-filter:blur(8px);}
    .modal.show{display:grid;}
    .modal .box{
      width:min(720px,calc(100vw - 24px));border-radius:20px;padding:20px;
      background:rgba(8,16,42,0.97);backdrop-filter:blur(20px);
      border:1px solid rgba(255,255,255,.2);box-shadow:var(--shadow-4);
    }
    .modal .box h3{margin:0 0 12px;font-size:1.1rem;color:var(--accent);}
    .modal .row{display:flex;gap:8px;margin:8px 0;}
    .modal input,.modal textarea{
      flex:1;padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.18);
      background:rgba(255,255,255,.08);color:var(--text);font-family:inherit;font-size:.92rem;outline:none;
      transition:border-color var(--dur-fast) var(--ease),background var(--dur-fast) var(--ease);
    }
    .modal input:focus,.modal textarea:focus{border-color:rgba(103,209,255,.5);background:rgba(255,255,255,.11);}
    .modal textarea{min-height:120px;resize:vertical;}
    .modal textarea::-webkit-scrollbar{width:8px;}
    .modal textarea::-webkit-scrollbar-thumb{background:rgba(103,209,255,.3);border-radius:8px;}

    /* ============================================================
       BADGE
       ============================================================ */
    .badge{
      display:inline-block;min-width:22px;text-align:center;font-weight:700;
      padding:3px 7px;border-radius:999px;
      background:linear-gradient(180deg,rgba(103,209,255,.28),rgba(127,255,212,.28));
      color:#041224;border:1px solid rgba(255,255,255,.24);font-size:.76rem;
    }

    /* Search bar */
    #searchBar{margin-bottom:12px;}

    /* ============================================================
       AI CHAT MODAL
       ============================================================ */
    .ai-avatar{
      width:30px;height:30px;border-radius:9px;flex-shrink:0;
      background:conic-gradient(from 120deg,var(--accent),var(--accent-2),var(--accent-3),var(--blue-4),var(--accent));
      animation:spinSoft 14s linear infinite;
    }
    .ai-bubble{
      background:rgba(255,255,255,.07);border:1px solid rgba(255,255,255,.12);
      border-radius:16px 16px 16px 4px;padding:11px 15px;
      font-size:.88rem;line-height:1.6;color:var(--text);max-width:85%;word-break:break-word;
    }
    .ai-msg.ai-user{flex-direction:row-reverse;}
    .ai-msg.ai-user .ai-bubble{
      background:linear-gradient(135deg,rgba(103,209,255,.22),rgba(127,255,212,.22));
      border-color:rgba(103,209,255,.4);color:#c8f0ff;
      border-radius:16px 16px 4px 16px;
    }
    .ai-msg.ai-user .ai-avatar{
      background:linear-gradient(135deg,rgba(103,209,255,.4),rgba(127,255,212,.4));
    }
    .ai-dot{
      width:7px;height:7px;border-radius:50%;background:var(--accent);
      animation:aiDot 1.2s ease infinite;
    }
    @keyframes aiDot{0%,80%,100%{transform:scale(.6);opacity:.4;}40%{transform:scale(1);opacity:1;}}
    #aiMessages::-webkit-scrollbar{width:6px;}
    #aiMessages::-webkit-scrollbar-thumb{background:rgba(103,209,255,.25);border-radius:6px;}
    #aiInput::-webkit-scrollbar{width:4px;}
    #aiInput::-webkit-scrollbar-thumb{background:rgba(103,209,255,.2);border-radius:4px;}
    .ai-bubble code{background:rgba(0,0,0,.3);padding:1px 5px;border-radius:4px;font-family:'Courier New',monospace;font-size:.82em;}
    .ai-bubble strong{color:var(--accent-2);}
  </style>
</head>
<body>
  <div class="bg" aria-hidden="true">
    <canvas id="particles"></canvas>
    <div class="bg-gradient"></div>
    <div class="blobs">
      <div class="blob" style="top:12%;left:6%;"></div>
      <div class="blob b2" style="bottom:10%;right:8%;"></div>
      <div class="blob b3" style="top:60%;left:70%;"></div>
    </div>
    <div class="parallax" id="parallax"></div>
  </div>

  <div class="app" id="app">
    <header class="main-header">
      <div class="logo" aria-hidden="true"></div>
      <h1>O&amp;B StarLauncher</h1>
      <div class="spacer"></div>
      <div class="actions">
        <div class="control" aria-label="Add game by URL">
          <input id="gameUrl" type="url" placeholder="Paste game URL (https://...)" autocomplete="off" inputmode="url"/>
          <button id="addBtn" class="btn">Add</button>
        </div>
        <div class="control">
          <button id="layoutBtn" class="btn">Layout</button>
          <button id="bgBtn" class="btn">Background</button>
          <button id="manageBtn" class="btn">Manage</button>
          <button id="statsBtn" class="btn">Stats</button>
        </div>
      </div>
    </header>

    <nav class="nav">
      <div class="pill active" id="viewAll">All <span class="badge" id="countAll">0</span></div>
      <div class="pill" id="viewItch">itch.io <span class="badge" id="countItch">0</span></div>
      <div class="pill" id="viewSites">Google Sites <span class="badge" id="countSites">0</span></div>
      <div class="pill" id="viewYT">YouTube <span class="badge" id="countYT">0</span></div>
      <div class="pill" id="viewOthers">Others <span class="badge" id="countOther">0</span></div>
      <div class="pill" id="searchToggle">üîç Search</div>
      <div class="pill" id="favoritesToggle">‚≠ê Favorites</div>
    </nav>

    <main class="content">
      <div class="toolbar" role="toolbar">
        <div class="chip" id="seedDemo">üå± Seed demos</div>
        <div class="chip" id="shuffle">üîÄ Shuffle</div>
        <div class="chip" id="sortAZ">A‚ÄìZ</div>
        <div class="chip" id="sortZA">Z‚ÄìA</div>
        <div class="chip" id="exportBtn">üì§ Export</div>
        <div class="chip" id="importBtn">üì• Import</div>
        <div class="chip" id="selectAll">Select all</div>
        <div class="chip" id="clearSelection">Clear sel.</div>
        <div class="chip" id="copyLinks">Copy links</div>
        <div class="chip" id="openSelectedTabs">Open tabs</div>
        <div class="chip" id="openSelectedBlanker">Blanker</div>
        <div class="chip" id="openSelectedBlankerFS">Blanker+FS</div>
        <div class="chip" id="aiChatBtn">ü§ñ AI Assistant</div>
      </div>

      <div id="searchBar" class="control" style="display:none;">
        <input id="searchInput" type="search" placeholder="Search by title or host‚Ä¶"/>
        <button id="searchClear" class="btn">Clear</button>
      </div>

      <section aria-label="Games grid">
        <div id="grid" class="grid">
          <div id="emptyState" class="empty">
            <div>
              <h2 style="margin:0 0 8px">No games yet</h2>
              <p style="margin:0;color:var(--muted)">Paste a URL above, or click <strong style="color:var(--text)">Seed demos</strong> to try some examples.</p>
            </div>
          </div>
        </div>
      </section>
    </main>

    <footer class="main-footer">
      <p><strong>Tips:</strong> Drag cards to reorder. Use checkboxes to select multiple. Keyboard: <strong>L</strong> = cycle layout, <strong>F</strong> = fullscreen first card, <strong>C</strong> = clear selection, <strong>Esc</strong> = close panels.</p>
    </footer>

    <div class="batch">
      <div class="left">
        <span class="chip" id="openSelectedTabs2">üìë Tabs</span>
        <span class="chip" id="openSelectedBlanker2">ü™ü Blanker</span>
        <span class="chip" id="openSelectedBlankerFS2">‚õ∂ Blanker+FS</span>
      </div>
      <div class="right">
        <span id="selectedCount" class="chip" style="pointer-events:none;cursor:default">Selected: 0</span>
      </div>
    </div>
  </div>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <!-- Background panel -->
  <div id="panel" class="panel" hidden>
    <h3>Background Settings</h3>
    <div class="row">
      <label for="bgStyle">Gradient style</label>
      <select id="bgStyle">
        <option value="radial">Radial</option>
        <option value="linear">Linear</option>
        <option value="dual">Dual radial</option>
      </select>
    </div>
    <div class="row"><label for="bgAngle">Linear angle (deg)</label><input id="bgAngle" type="range" min="0" max="360" value="135"/></div>
    <div class="row"><label for="accentColor">Accent color</label><input id="accentColor" type="color" value="#67d1ff"/></div>
    <div class="row"><label for="accent2Color">Accent 2</label><input id="accent2Color" type="color" value="#7fffd4"/></div>
    <div class="row"><label for="accent3Color">Accent 3</label><input id="accent3Color" type="color" value="#b28aff"/></div>
    <div class="row"><label for="sat">Saturation</label><input id="sat" type="range" min="80" max="150" value="112"/></div>
    <div class="row"><label for="contrast">Contrast</label><input id="contrast" type="range" min="90" max="150" value="108"/></div>
    <div class="row"><label for="parallaxDepth">Parallax depth</label><input id="parallaxDepth" type="range" min="0" max="30" value="14"/></div>
    <div class="row switch"><input id="toggleParticles" type="checkbox" checked/><label for="toggleParticles">Enable particles</label></div>
    <div class="row switch"><input id="toggleBlobs" type="checkbox" checked/><label for="toggleBlobs">Enable blobs</label></div>
    <div class="btns">
      <span id="bgReset" class="chip" style="flex:1;text-align:center">Reset</span>
      <span id="bgClose" class="chip" style="flex:1;text-align:center">Close</span>
    </div>
  </div>

  <!-- Manage modal -->
  <div id="manageModal" class="modal">
    <div class="box">
      <h3>Manage Games</h3>
      <div class="row"><textarea id="bulkInput" placeholder="Paste multiple URLs (one per line or space-separated)‚Ä¶"></textarea></div>
      <div class="row">
        <input id="renameInput" type="text" placeholder="Rename all (optional)"/>
        <input id="tagInput" type="text" placeholder="Tag (optional)"/>
      </div>
      <div class="row" style="justify-content:flex-end;gap:10px;">
        <button id="bulkAdd" class="btn">Bulk Add</button>
        <button id="bulkClose" class="btn" style="background:rgba(255,255,255,.14);color:var(--text);box-shadow:none;">Close</button>
      </div>
    </div>
  </div>

  <!-- Stats modal -->
  <div id="statsModal" class="modal">
    <div class="box">
      <h3>Collection Stats</h3>
      <div class="row" style="flex-wrap:wrap;gap:10px;">
        <div class="chip" id="statTotal">Total: 0</div>
        <div class="chip" id="statItch">itch.io: 0</div>
        <div class="chip" id="statSites">Sites: 0</div>
        <div class="chip" id="statYT">YouTube: 0</div>
        <div class="chip" id="statOther">Others: 0</div>
        <div class="chip" id="statFavs">Favorites: 0</div>
      </div>
      <div class="row" style="justify-content:flex-end;margin-top:12px;">
        <button id="statsClose" class="btn">Close</button>
      </div>
    </div>
  </div>

  <script>
  ;(()=>{
    "use strict";

    const qs = s => document.querySelector(s);
    const qsa = s => Array.from(document.querySelectorAll(s));

    /* ============================================================
       Store
       ============================================================ */
    const Store = {
      itemsKey:'dbg_items_v6', prefsKey:'dbg_prefs_v6', favsKey:'dbg_favs_v6',
      loadItems(){ try{ return JSON.parse(localStorage.getItem(this.itemsKey))||[]; }catch(e){ return []; } },
      saveItems(l){ try{ localStorage.setItem(this.itemsKey, JSON.stringify(l)); }catch(e){} },
      loadPrefs(){ try{ return JSON.parse(localStorage.getItem(this.prefsKey))||null; }catch(e){ return null; } },
      savePrefs(p){ try{ localStorage.setItem(this.prefsKey, JSON.stringify(p)); }catch(e){} },
      loadFavs(){ try{ return new Set(JSON.parse(localStorage.getItem(this.favsKey))||[]); }catch(e){ return new Set(); } },
      saveFavs(s){ try{ localStorage.setItem(this.favsKey, JSON.stringify([...s])); }catch(e){} }
    };

    /* Toast */
    const toastEl = qs('#toast');
    let toastTimer = null;
    function toast(msg, ms=2000){
      toastEl.textContent = msg;
      toastEl.classList.add('show');
      clearTimeout(toastTimer);
      toastTimer = setTimeout(()=> toastEl.classList.remove('show'), ms);
    }

    /* URL utils */
    function normalizeUrl(u){
      if(!u) return null;
      u = u.trim();
      if(!/^https?:\/\//i.test(u)) u = 'https://' + u;
      try{ const url=new URL(u); if(url.protocol!=='https:') url.protocol='https:'; return url.toString(); }
      catch(e){ return null; }
    }
    function deriveTitle(u){
      try{
        const {hostname, pathname} = new URL(u);
        const host = hostname.replace(/^www\./,'');
        const segs = pathname.split('/').filter(Boolean);
        const last = segs[segs.length-1] || host;
        return decodeURIComponent(last).replace(/[-_]+/g,' ').replace(/\.\w+$/,'').slice(0,80).trim() || host;
      }catch(e){ return 'Game'; }
    }
    function computeEmbedSrc(u){
      try{
        const url = new URL(u);
        if(url.hostname.endsWith('.itch.io')||url.hostname==='itch.io'){
          if(!url.pathname.endsWith('/embed')) url.pathname = url.pathname.replace(/\/+$/,'')+'/embed';
          return url.toString();
        }
        if(url.hostname.includes('sites.google.com')){ url.searchParams.set('embedded','true'); return url.toString(); }
        if(/(youtube\.com|youtu\.be)/.test(url.hostname)){
          let vid = url.hostname.includes('youtu.be') ? url.pathname.split('/').pop() : url.searchParams.get('v');
          if(vid){ const e=new URL('https://www.youtube.com/embed/'+vid); e.searchParams.set('rel','0'); e.searchParams.set('modestbranding','1'); return e.toString(); }
        }
        return u;
      }catch(e){ return u; }
    }
    function classifyHost(u){
      try{
        const h = new URL(u).hostname;
        if(h.endsWith('.itch.io')||h==='itch.io') return 'itch';
        if(h.includes('sites.google.com')) return 'sites';
        if(h.includes('youtube.com')||h.includes('youtu.be')) return 'yt';
        return 'other';
      }catch(e){ return 'other'; }
    }

    /* Icons */
    function icon(name){
      const NS='http://www.w3.org/2000/svg', svg=document.createElementNS(NS,'svg'), p=document.createElementNS(NS,'path');
      svg.setAttribute('viewBox','0 0 24 24');
      const paths={
        close:'M6.7 6.7a1 1 0 0 1 1.4 0L12 10.6l3.9-3.9a1 1 0 1 1 1.4 1.4L13.4 12l3.9 3.9a1 1 0 0 1-1.4 1.4L12 13.4l-3.9 3.9a1 1 0 0 1-1.4-1.4L10.6 12 6.7 8.1a1 1 0 0 1 0-1.4Z',
        expand:'M7 3h4v2H9v2H7V5H5V3h2Zm10 8h2v4h-2v2h-2v-2h-2v-4h2V9h2v2Zm-6 10H7v-2H5v-2h2v2h2v2Zm-8-8H1V9h2V7h2v2H3v2Z',
        open:'M5 4h8a1 1 0 0 1 1 1v2h-2V6H6v12h6v-1h2v2a1 1 0 0 1-1 1H5a1 1 0 0 1-1-1V5a1 1 0 0 1 1-1Zm12.3 6.3a1 1 0 0 0-1.4 1.4l1.3 1.3H12a1 1 0 1 0 0 2h5.2l-1.3 1.3a1 1 0 0 0 1.4 1.4l3.2-3.2a1 1 0 0 0 0-1.4l-3.2-3.2Z',
        blanker:'M4 3h10a1 1 0 0 1 1 1v2H5v12h10v-2h2v2a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V4a1 1 0 0 1 1-1Zm11 4h5a1 1 0 0 1 1 1v11h-2V9h-4V7Z',
        star:'M12 2l3.1 6.3 7 .9-5.1 4.9 1.3 6.9L12 17l-6.3 4 1.3-6.9L2 9.2l7-.9L12 2Z',
        edit:'M4 16.5V20h3.5l10-10L14 6.5l-10 10ZM20.7 7.3a1 1 0 0 0 0-1.4L18.1 3.3a1 1 0 0 0-1.4 0L15.3 4.7l3.6 3.6 1.8-1Z'
      };
      p.setAttribute('d', paths[name]||paths.star);
      svg.appendChild(p); return svg;
    }

    /* Blanker */
    window.makeBlankerHTML = function makeBlankerHTML(title, src, autoFS=false){
      const t = String(title||'Game').replace(/</g,'&lt;').replace(/>/g,'&gt;');
      const s = String(src).replace(/\\/g,'\\\\').replace(/'/g,"\\'");
      return `<!DOCTYPE html><html><head><meta charset="utf-8"/><title>${t}</title><meta name="viewport" content="width=device-width,initial-scale=1"/><style>html,body{height:100%;margin:0;background:#000;overflow:hidden;font-family:system-ui,Arial;}.bar{position:fixed;top:10px;left:50%;transform:translateX(-50%);display:flex;gap:8px;align-items:center;background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.25);color:#fff;padding:8px 10px;border-radius:12px;z-index:20;backdrop-filter:blur(8px);}.btn{padding:8px 12px;border-radius:10px;border:0;cursor:pointer;font-weight:700;color:#041224;background:linear-gradient(180deg,#67d1ff,#a0e7ff);}iframe{position:absolute;inset:0;width:100%;height:100%;border:0;}</style></head><body><div class="bar"><span>\u25c4 Back</span><button id="fs" class="btn">Fullscreen</button><button id="pop" class="btn">Open Tab</button></div><iframe id="gf" src="${src}" allow="fullscreen *; autoplay *; microphone *; gamepad *" allowfullscreen></iframe><script>document.getElementById('fs').addEventListener('click',()=>{const f=document.getElementById('gf');(f.requestFullscreen||f.webkitRequestFullscreen||f.mozRequestFullScreen||function(){}).call(f);});document.getElementById('pop').addEventListener('click',()=>{window.open('${s}','_blank','noopener');});${autoFS?"setTimeout(()=>{document.getElementById('fs').click();},600);":""}<\/script></body></html>`;
    }

    /* ============================================================
       State
       ============================================================ */
    let items = Store.loadItems();
    const favs = Store.loadFavs();
    let selected = new Set();
    let filterMode = 'all';
    let showFavoritesOnly = false;
    let query = '';
    let layoutMode = 3;

    const grid = qs('#grid');
    const emptyState = qs('#emptyState');

    function filtered(){
      return items.filter(item=>{
        const h = classifyHost(item.src);
        if(filterMode!=='all' && h!==filterMode) return false;
        if(showFavoritesOnly && !favs.has(item.id)) return false;
        if(query){
          const q = query.toLowerCase();
          const inTitle = (item.title||'').toLowerCase().includes(q);
          let inHost = false; try{ inHost = new URL(item.src).hostname.toLowerCase().includes(q); }catch(e){}
          if(!inTitle && !inHost) return false;
        }
        return true;
      });
    }

    function getSpanForLayout(){ return layoutMode===3?4:layoutMode===2?6:12; }

    function applyLayout(){
      const span = getSpanForLayout();
      qsa('.card').forEach(c=> c.style.gridColumn='span '+span);
    }

    function updateCounts(){
      qs('#countAll').textContent = String(items.length);
      qs('#countItch').textContent = String(items.filter(x=>classifyHost(x.src)==='itch').length);
      qs('#countSites').textContent = String(items.filter(x=>classifyHost(x.src)==='sites').length);
      qs('#countYT').textContent = String(items.filter(x=>classifyHost(x.src)==='yt').length);
      qs('#countOther').textContent = String(items.filter(x=>classifyHost(x.src)==='other').length);
    }
    function updateStats(){
      qs('#statTotal').textContent='Total: '+items.length;
      qs('#statItch').textContent='itch.io: '+items.filter(x=>classifyHost(x.src)==='itch').length;
      qs('#statSites').textContent='Sites: '+items.filter(x=>classifyHost(x.src)==='sites').length;
      qs('#statYT').textContent='YouTube: '+items.filter(x=>classifyHost(x.src)==='yt').length;
      qs('#statOther').textContent='Others: '+items.filter(x=>classifyHost(x.src)==='other').length;
      qs('#statFavs').textContent='Favorites: '+items.filter(x=>favs.has(x.id)).length;
    }
    function updateSelectedCount(){ qs('#selectedCount').textContent='Selected: '+selected.size; }
    function updateSelection(id,on){ if(on) selected.add(id); else selected.delete(id); updateSelectedCount(); }
    function getSelectedItems(){ const ids=[...selected]; return filtered().filter(x=>ids.includes(x.id)); }

    /* ============================================================
       Card builder
       ============================================================ */
    function cardTemplate({id, title, src, tag}){
      const card = document.createElement('article');
      card.className='card'; card.dataset.id=id;
      card.style.gridColumn='span '+getSpanForLayout();

      /* Card header */
      const head = document.createElement('div');
      head.className='card-header';

      const left = document.createElement('div');
      left.style.cssText='display:flex;align-items:center;gap:8px;min-width:0;flex:1;overflow:hidden;';

      const cLogo = document.createElement('div');
      cLogo.className='card-logo';

      const h2 = document.createElement('h2');
      h2.className=''; h2.style.cssText='margin:0;font-size:1rem;font-weight:700;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:22ch;';
      h2.textContent = title||'Game'; h2.title=title||'Game';

      const titleWrap = document.createElement('div');
      titleWrap.className='title';
      titleWrap.append(cLogo, h2);

      const meta = document.createElement('div');
      meta.className='meta';
      try{ meta.textContent=new URL(src).hostname.replace(/^www\./,''); }catch(e){}

      left.append(titleWrap, meta);

      const right = document.createElement('div');
      right.style.cssText='display:flex;align-items:center;gap:6px;flex-shrink:0;';

      const selLabel = document.createElement('label');
      selLabel.className='select';
      const cb = document.createElement('input');
      cb.type='checkbox';
      cb.addEventListener('change',()=>updateSelection(id,cb.checked));
      selLabel.append(cb,' Select');

      const tools = document.createElement('div');
      tools.className='tools';

      function mkBtn(icn, tip, fn){
        const b=document.createElement('button');
        b.className='btn-icon'; b.title=tip;
        b.appendChild(icon(icn));
        b.addEventListener('click', fn);
        return b;
      }

      const btnOpen    = mkBtn('open','Open in new tab',()=>window.open(src,'_blank','noopener'));
      const btnBlanker = mkBtn('blanker','Open in about:blanker',()=>{ const _h=window.makeBlankerHTML(title,src,false);window.open('data:text/html;charset=utf-8,'+encodeURIComponent(_h),'_blank');});
      const btnBlankerFS = mkBtn('expand','Blanker + fullscreen',()=>{ const _h=window.makeBlankerHTML(title,src,true);window.open('data:text/html;charset=utf-8,'+encodeURIComponent(_h),'_blank');});
      const btnExpand  = mkBtn('expand','Fullscreen card',()=>toggleFullscreen(card));
      const btnEdit    = mkBtn('edit','Rename',()=>{
        const n=prompt('New title:',h2.textContent);
        if(n&&n.trim()){ h2.textContent=n.trim(); h2.title=n.trim(); const it=items.find(x=>x.id===id); if(it){it.title=n.trim();Store.saveItems(items);} }
      });

      /* Favorite */
      const btnFav = document.createElement('button');
      btnFav.className='btn-icon'; btnFav.title='Toggle favorite';
      btnFav.appendChild(icon('star'));
      const syncFav=()=>{
        card.classList.toggle('favorited',favs.has(id));
        btnFav.style.background = favs.has(id)?'linear-gradient(180deg,rgba(178,138,255,.45),rgba(127,255,212,.45))':'rgba(255,255,255,.08)';
        btnFav.style.borderColor = favs.has(id)?'rgba(178,138,255,.6)':'rgba(255,255,255,.16)';
      };
      syncFav();
      btnFav.addEventListener('click',()=>{ favs.has(id)?favs.delete(id):favs.add(id); Store.saveFavs(favs); syncFav(); updateStats(); });

      const btnRemove = mkBtn('close','Remove',()=>{ if(confirm('Remove "'+h2.textContent+'"?')) removeCard(id); });

      tools.append(btnOpen, btnBlanker, btnBlankerFS, btnExpand, btnEdit, btnFav, btnRemove);
      right.append(selLabel, tools);
      head.append(left, right);

      /* Frame ‚Äî thumbnail for huffine games (they block iframes), iframe for others */
      const frame = document.createElement('div');
      frame.className='frame';
      const isHuffine = src.includes('huffine.github.io');
      if(isHuffine){
        const thumb = document.createElement('div');
        thumb.className='game-thumb';
        const thumbUrl = getGameThumb(title);
        thumb.style.cssText='width:100%;height:100%;background:url('+JSON.stringify(thumbUrl)+') center/cover no-repeat,linear-gradient(135deg,var(--blue-3),var(--blue-1));display:flex;align-items:flex-end;justify-content:center;cursor:pointer;position:relative;';
        const playBtn = document.createElement('div');
        playBtn.className='thumb-play-btn';
        playBtn.textContent='‚ñ∂ Play';
        thumb.appendChild(playBtn);
        thumb.addEventListener('click',()=>{ const _h=window.makeBlankerHTML(title,src,false);window.open('data:text/html;charset=utf-8,'+encodeURIComponent(_h),'_blank'); });
        frame.appendChild(thumb);
      } else {
        const iframe = document.createElement('iframe');
        iframe.loading='lazy'; iframe.referrerPolicy='no-referrer-when-downgrade'; iframe.allow='fullscreen';
        iframe.src=computeEmbedSrc(src);
        frame.appendChild(iframe);
      }

      /* Ribbon */
      const ribbon = document.createElement('div');
      ribbon.className='ribbon'; ribbon.textContent=classifyHost(src).toUpperCase();

      /* Fav tag */
      const favTag = document.createElement('div');
      favTag.className='fav-tag'; favTag.textContent='‚òÖ FAVORITE';

      /* User tag */
      if(tag){
        const ut=document.createElement('div');
        ut.className='fav-tag';
        ut.style.cssText='display:block!important;bottom:10px;left:10px;right:auto;background:linear-gradient(180deg,rgba(178,138,255,.85),rgba(103,209,255,.85));';
        ut.textContent=String(tag).slice(0,24);
        card.appendChild(ut);
      }

      /* Action bar ‚Äî big clear buttons below the thumbnail */
      const actions = document.createElement('div');
      actions.className='card-actions';

      function mkActBtn(label, cls, tip, fn){
        const b=document.createElement('button');
        b.className='act-btn '+cls; b.title=tip; b.innerHTML=label;
        b.addEventListener('click',e=>{e.stopPropagation();fn();});
        return b;
      }

      const aPlay = mkActBtn('‚ñ∂ Play','play','Open in Blanker window',()=>{
        const _h=window.makeBlankerHTML(title,src,false);
        window.open('data:text/html;charset=utf-8,'+encodeURIComponent(_h),'_blank');
      });
      const aFS = mkActBtn('‚õ∂ Fullscreen','play fs','Open fullscreen in Blanker',()=>{
        const _h=window.makeBlankerHTML(title,src,true);
        window.open('data:text/html;charset=utf-8,'+encodeURIComponent(_h),'_blank');
      });
      const aTab = mkActBtn('‚Üó New Tab','newtab','Open in new tab directly',()=>{
        window.open(src,'_blank','noopener');
      });
      actions.append(aPlay, aFS, aTab);

      card.append(head, frame, actions, ribbon, favTag);
      return card;
    }

    /* Fullscreen */
    let fsEl=null;
    function toggleFullscreen(card){
      if(document.fullscreenElement){ document.exitFullscreen?.().catch(()=>{}); }
      else{ fsEl=card; card.requestFullscreen?.().catch(()=>{}); }
    }
    document.addEventListener('fullscreenchange',()=>{ if(!document.fullscreenElement) fsEl=null; });

    /* Render */
    function render(){
      grid.innerHTML='';
      const list=filtered();
      if(!list.length){
        grid.appendChild(emptyState);
      }else{
        list.forEach(item=> grid.appendChild(cardTemplate(item)));
      }
      applyLayout();
      bindReveal();
      updateSelectedCount();
      enableDragging();
      updateCounts();
    }

    function addItem(url, tag){
      const clean=normalizeUrl(url);
      if(!clean){ toast('‚ö† Invalid URL'); return; }
      items.unshift({ id:crypto.randomUUID?.()|| String(Date.now()+Math.random()), title:deriveTitle(clean), src:clean, tag:tag||'' });
      Store.saveItems(items); render(); toast('‚úì Added!'); qs('#gameUrl').value='';
    }

    function removeCard(id){
      items=items.filter(x=>x.id!==id); selected.delete(id); favs.delete(id);
      Store.saveItems(items); Store.saveFavs(favs); render(); toast('Removed');
    }

    /* Selection helpers */
    function openInTabs(list){ if(!list.length){toast('Nothing selected');return;} let n=0; list.forEach(i=>{const w=window.open(i.src,'_blank','noopener');if(w)n++;}); toast(`Opened ${n} tab(s)`); }
    function openInBlanker(list,fs=false){ if(!list.length){toast('Nothing selected');return;} let n=0; list.forEach(i=>{const _h=window.makeBlankerHTML(i.title,i.src,fs);const w=window.open('data:text/html;charset=utf-8,'+encodeURIComponent(_h),'_blank');if(w)n++;}); toast(`Opened ${n} blanker(s)`); }

    /* Drag reorder */
    function enableDragging(){
      let drag=null;
      function onDown(e){
        const card=e.target.closest('.card');
        if(!card||e.target.closest('.btn-icon')||e.target.tagName==='INPUT') return;
        drag={card,x0:e.clientX,y0:e.clientY,moved:false};
      }
      function onMove(e){
        if(!drag) return;
        const dx=e.clientX-drag.x0, dy=e.clientY-drag.y0;
        if(!drag.moved&&Math.hypot(dx,dy)<6) return;
        drag.moved=true;
        drag.card.style.cssText='opacity:.75;transform:translate('+dx+'px,'+dy+'px) scale(.99);transition:none;z-index:20;';
        const cards=qsa('.card').filter(c=>c!==drag.card);
        let nearest=null,minD=Infinity;
        cards.forEach(c=>{ const r=c.getBoundingClientRect(),d=Math.hypot(e.clientX-(r.left+r.width/2),e.clientY-(r.top+r.height/2)); if(d<minD){minD=d;nearest=c;} });
        if(nearest){ const r=nearest.getBoundingClientRect(); grid.insertBefore(drag.card, e.clientY<r.top+r.height/2 ? nearest : nearest.nextSibling); }
      }
      function onUp(){
        if(!drag) return;
        const {card,moved}=drag; drag=null;
        card.style.cssText='';
        if(moved){ const o=qsa('.card').map(c=>c.dataset.id); items.sort((a,b)=>o.indexOf(a.id)-o.indexOf(b.id)); Store.saveItems(items); toast('Order saved'); }
      }
      grid.addEventListener('pointerdown',onDown);
      grid.addEventListener('pointermove',onMove);
      grid.addEventListener('pointerup',onUp);
      grid.addEventListener('pointercancel',onUp);
    }

    /* Reveal */
    let revObs=null;
    function bindReveal(){
      if(revObs) revObs.disconnect();
      revObs=new IntersectionObserver(entries=>entries.forEach(e=>{ if(e.isIntersecting){e.target.style.animation='none';e.target.offsetHeight;e.target.style.animation='floatIn var(--dur-slow) var(--ease) both';revObs.unobserve(e.target);} }),{threshold:.1});
      qsa('.card,.empty').forEach(el=>revObs.observe(el));
    }

    /* Parallax */
    function initParallax(){
      const el=qs('#parallax');
      window.addEventListener('pointermove',e=>{
        const d=parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--bg-parallax'))||14;
        el.style.transform=`translate3d(${(e.clientX/innerWidth-.5)*d}px,${(e.clientY/innerHeight-.5)*d}px,0)`;
      });
    }

    /* Background prefs */
    const prefsDefault={style:'radial',angle:135,accent:'#67d1ff',accent2:'#7fffd4',accent3:'#b28aff',sat:112,contrast:108,parallax:14,particles:true,blobs:true};
    let prefs=Object.assign({},prefsDefault,Store.loadPrefs()||{});

    function applyPrefs(){
      const r=document.documentElement;
      r.style.setProperty('--accent',prefs.accent);
      r.style.setProperty('--accent-2',prefs.accent2);
      r.style.setProperty('--accent-3',prefs.accent3);
      r.style.setProperty('--bg-parallax',prefs.parallax);
      r.style.setProperty('--bg-sat',prefs.sat+'%');
      r.style.setProperty('--bg-contrast',prefs.contrast+'%');
      const bgs = prefs.style==='radial'?`radial-gradient(1400px 900px at 24% 18%,var(--blue-4) 0%,var(--blue-2) 35%,var(--blue-1) 62%,var(--blue-0) 100%)`:
                  prefs.style==='linear'?`linear-gradient(${prefs.angle}deg,var(--blue-5) 0%,var(--blue-4) 30%,var(--blue-3) 55%,var(--blue-2) 80%,var(--blue-1) 100%)`:
                  `radial-gradient(1400px 900px at 18% 22%,var(--blue-4) 0%,transparent 45%),radial-gradient(1400px 900px at 82% 78%,var(--blue-3) 0%,var(--blue-0) 100%)`;
      document.body.style.background=bgs;
      window.__toggleParticles?.(prefs.particles);
      qs('#particles').style.display=prefs.particles?'':'none';
      qs('.blobs').style.display=prefs.blobs?'':'none';
    }

    /* Particles */
    let particlesOn=true;
    function initParticles(){
      const canvas=qs('#particles'), ctx=canvas.getContext('2d');
      let W=0,H=0,pts=[]; const DPR=Math.min(2,devicePixelRatio||1);
      let mx=-9999,my=-9999;
      function resize(){
        W=innerWidth;H=innerHeight;
        canvas.width=W*DPR;canvas.height=H*DPR;
        canvas.style.width=W+'px';canvas.style.height=H+'px';
        ctx.setTransform(DPR,0,0,DPR,0,0);
        pts=[]; const N=Math.min(110,Math.floor(W*H/16000));
        for(let i=0;i<N;i++) pts.push({x:Math.random()*W,y:Math.random()*H,r:1+Math.random()*2,a:.2+Math.random()*.6,vx:(Math.random()-.5)*.24,vy:(Math.random()-.5)*.24});
      }
      window.addEventListener('resize',resize); resize();
      (function step(){
        requestAnimationFrame(step); ctx.clearRect(0,0,W,H);
        if(!particlesOn) return;
        for(const p of pts){
          const dx=mx-p.x,dy=my-p.y,d2=dx*dx+dy*dy;
          if(d2>0&&d2<80000){const f=Math.min(1.5,6000/d2);p.vx+=dx*.0003*f;p.vy+=dy*.0003*f;}
          p.vx*=.996;p.vy*=.996;p.x+=p.vx;p.y+=p.vy;
          if(p.x<-10)p.x=W+10;if(p.x>W+10)p.x=-10;if(p.y<-10)p.y=H+10;if(p.y>H+10)p.y=-10;
          ctx.globalAlpha=p.a;ctx.beginPath();ctx.arc(p.x,p.y,p.r,0,Math.PI*2);ctx.fillStyle='rgba(127,255,212,.5)';ctx.fill();
        }
        ctx.globalAlpha=1;
      })();
      window.addEventListener('pointermove',e=>{mx=e.clientX;my=e.clientY;});
      window.addEventListener('pointerleave',()=>{mx=-9999;my=-9999;});
      window.__toggleParticles=on=>{particlesOn=!!on;};
    }


    /* ============================================================
       GAME THUMBNAILS
       ============================================================ */
    function getGameThumb(title){
      const map = {
      
      return map[title.toLowerCase()] || '';
    }
      {title:'Call of Duty Zombies',src:'https://huffine.github.io/games/nzpz/index.html'},
        {title:'Hollow Knight',src:'https://huffine.github.io/games/Hollow-Knight/index.html'},
        {title:'Raft',src:'https://huffine.github.io/games/Raft/index.html'},
        {title:'Bendy and the Ink Machine',src:'https://huffine.github.io/games/Bendy-and-the-Ink-Machine/index.html'},
        {title:'Minecraft 1.8.8',src:'https://huffine.github.io/games/minecraft/Astra_Client.html'},
        {title:'Minecraft 1.12.2',src:'https://huffine.github.io/games/minecraft/mincraft1,12,2.html'},
        {title:'Buckshot Roulette',src:'https://huffine.github.io/games/Buckshot-Roulette/index.html'},
        {title:'Five Nights at Freddys',src:'https://huffine.github.io/games/FNAF/1.html'},
        {title:'Five Nights at Freddys 2',src:'https://huffine.github.io/games/FNAF/2.html'},
        {title:'Five Nights at Freddys 3',src:'https://huffine.github.io/games/FNAF/3.html'},
        {title:'Five Nights at Freddys 4',src:'https://huffine.github.io/games/FNAF/4.html'},
        {title:'FNAF Sister Location',src:'https://huffine.github.io/games/FNAF/sisterlocation.html'},
        {title:'R.E.P.O',src:'https://huffine.github.io/games/R.E.P.O/index.html'},
        {title:"That's Not My Neighbor",src:'https://huffine.github.io/games/Thats-Not-My-Neighbor/index.html'},
        {title:'The Deadseat',src:'https://huffine.github.io/games/The-Deadseat/index.html'},
        {title:'Snow Rider 3D',src:'https://huffine.github.io/games/SnowRider3D/Snow-Rider-3D.html'},
        {title:'UltraKill',src:'https://huffine.github.io/games/Ultrakill/index.html'},
        {title:'Undertale',src:'https://huffine.github.io/games/Undertale/index.html'},
        {title:'Unicycle Hero',src:'https://huffine.github.io/games/unicycle-hero/unicycle-hero.html'},
        {title:"Baldi's Basics",src:'https://huffine.github.io/games/Baldis-basics/index.html'},
        {title:'Fears to Fathom Home Alone',src:'https://huffine.github.io/games/home-alone/index.html'},
        {title:'Hotline Miami',src:'https://huffine.github.io/games/hotline-miami/index.html'},
        {title:'The Man In The Window',src:'https://huffine.github.io/games/the-man-in-the-window/index.html'},
        {title:'CupHead',src:'https://huffine.github.io/games/CupHead/index.html'},
        {title:'Slender',src:'https://huffine.github.io/games/Slender/index.html'},
        {title:'Alien Hominid',src:'https://huffine.github.io/games/alien-hominid/Alien%20Hominid.html'},
        {title:'Angry Birds',src:'https://huffine.github.io/games/angry-birds/Angry%20Birds.html'},
        {title:'Backrooms',src:'https://huffine.github.io/games/backrooms/Backrooms.html'},
        {title:'Basket Random',src:'https://huffine.github.io/games/basket-random/Basket%20Random.html'},
        {title:'Bloons TD 4',src:'https://huffine.github.io/games/bloons-td4/Bloons%20TD%204.html'},
        {title:'Bloons TD 6',src:'https://huffine.github.io/games/bloonstd6/btd6.html'},
        {title:'Bloxorz',src:'https://huffine.github.io/games/bloxorz/Bloxorz.html'},
        {title:'Burrito Bison',src:'https://huffine.github.io/games/burito-bison/Burrito%20Bison.html'},
        {title:'Candy Crush',src:'https://huffine.github.io/games/candy-crush/Candy%20Crush.html'},
        {title:'Chess Classic',src:'https://huffine.github.io/games/chess-classic/Chess%20Classic.html'},
        {title:'City Smash',src:'https://huffine.github.io/games/city-smash/City%20Smash.html'},
        {title:'Cluster Truck',src:'https://huffine.github.io/games/cluster-truck/Cluster%20Rush.html'},
        {title:'Cookie Clicker',src:'https://huffine.github.io/games/cookie-clicker/Cookie%20Clicker.html'},
        {title:'Crazy Cattle 3D',src:'https://huffine.github.io/games/crazy-cattle-3d/Crazy%20Cattle%203D.html'},
        {title:'Crossy Road',src:'https://huffine.github.io/games/crossy-road/Crossy%20Road.html'},
        {title:'Cut the Rope',src:'https://huffine.github.io/games/cut-the-rope/Cut%20the%20Rope.html'},
        {title:'Deltarune',src:'https://huffine.github.io/games/deltarune/Deltarune.html'},
        {title:'Flappy Bird',src:'https://huffine.github.io/games/flappy-bird/Flappy%20Bird.html'},
        {title:'Fruit Ninja',src:'https://huffine.github.io/games/fruit-ninja/Fruit%20Ninja.html'},
        {title:'Geometry Dash',src:'https://huffine.github.io/games/geometry-dash/Geometry%20Dash%20Lite.html'},
        {title:'Google Baseball',src:'https://huffine.github.io/games/google-baseball/Google%20Baseball.html'},
        {title:'Granny',src:'https://huffine.github.io/games/granny/Granny.html'},
        {title:'Granny 2',src:'https://huffine.github.io/games/granny-2/Granny.html%202'},
        {title:'Granny 3',src:'https://huffine.github.io/games/granny-3/Granny.html%203'},
        {title:'Half Life',src:'https://huffine.github.io/games/halflife/Half%20Life.html'},
        {title:'Idle Breakout',src:'https://huffine.github.io/games/idle-breakout/Idle%20Breakout.html'},
        {title:'Jetpack Joyride',src:'https://huffine.github.io/games/jetpack-joyride/Jetpack%20Joyride.html'},
        {title:'Magic Tiles 3',src:'https://huffine.github.io/games/magic-tiles-3/Magic%20Tiles%203.html'},
        {title:'Paper.io 2',src:'https://huffine.github.io/games/paper.io2/Paper.io%202.html'},
        {title:'Plants vs Zombies',src:'https://huffine.github.io/games/plantsvszombies/Plants%20vs%20Zombies.html'},
        {title:'Retro Bowl College',src:'https://huffine.github.io/games/retro-bowl-college/Retro%20Bowl%20College.html'},
        {title:'Retro Bowl',src:'https://huffine.github.io/games/retro-bowl/Retro%20Bowl.html'},
        {title:'Run 3',src:'https://huffine.github.io/games/run3/Run%203.html'},
        {title:'Solar Smash',src:'https://huffine.github.io/games/solar-smash/Solar%20Smash.html'},
        {title:'Slope',src:'https://huffine.github.io/games/Slope/Slope.html'},
        {title:'Slope 2',src:'https://huffine.github.io/games/Slope/Slope%202.html'},
        {title:'Speed Stars',src:'https://huffine.github.io/games/speed-stars/Speed%20Stars.html'},
        {title:'Station Saturn',src:'https://huffine.github.io/games/station-saturn/Station%20Saturn.html'},
        {title:'Subway Surfers',src:'https://huffine.github.io/games/subway-surfers/Subway%20Surfers_%20Miami.html'},
        {title:'Superhot',src:'https://huffine.github.io/games/superhot/Superhot.html'},
        {title:'Temple Run 2',src:'https://huffine.github.io/games/templerun2/Temple%20Run%202.html'},
        {title:'Vex 7',src:'https://huffine.github.io/games/vex7/Vex%207.html'},
        {title:'Drift Hunters',src:'https://huffine.github.io/games/drift-hunters/drift-hunters.html'},
        {title:"Pretend It's Not There",src:'https://huffine.github.io/games/pint/pretenditsnotthere.html'},
        {title:'Slither.io',src:'https://huffine.github.io/games/slither/sfge.html'},
        {title:'Happy Wheels',src:'https://huffine.github.io/games/happywheels/happywheelss.html'},
        {title:'Kindergarten',src:'https://huffine.github.io/games/kindergarten/index.html'},
        {title:'Kindergarten 2',src:'https://huffine.github.io/games/kindergarten%202/index.html'},
        {title:'Kindergarten 3',src:'https://huffine.github.io/games/kindergarten%203/Kindergarten3.html'},
        {title:'MOTO X3M',src:'https://huffine.github.io/games/motox3m/motox3m.html'},
        {title:'2048',src:'https://huffine.github.io/games/2048/2048.html'},
        {title:'8 Ball Pool',src:'https://huffine.github.io/games/8-ball-pool/8%20Ball%20Pool.html'},
        {title:'3D Bowling',src:'https://huffine.github.io/games/3d-bowling/3D%20Bowling.html'},
      ];

    function seedDemos(){
      // Clear existing items to avoid duplicates when re-seeding
      if(items.length && !confirm('Replace current games with the full Portland Galaxy library?')) return;
      items=[];
      const games=[
        {title:'Call of Duty Zombies',src:'https://huffine.github.io/games/nzpz/index.html'},
        {title:'Hollow Knight',src:'https://huffine.github.io/games/Hollow-Knight/index.html'},
        {title:'Raft',src:'https://huffine.github.io/games/Raft/index.html'},
        {title:'Bendy and the Ink Machine',src:'https://huffine.github.io/games/Bendy-and-the-Ink-Machine/index.html'},
        {title:'Minecraft 1.8.8',src:'https://huffine.github.io/games/minecraft/Astra_Client.html'},
        {title:'Minecraft 1.12.2',src:'https://huffine.github.io/games/minecraft/mincraft1,12,2.html'},
        {title:'Buckshot Roulette',src:'https://huffine.github.io/games/Buckshot-Roulette/index.html'},
        {title:'Five Nights at Freddys',src:'https://huffine.github.io/games/FNAF/1.html'},
        {title:'Five Nights at Freddys 2',src:'https://huffine.github.io/games/FNAF/2.html'},
        {title:'Five Nights at Freddys 3',src:'https://huffine.github.io/games/FNAF/3.html'},
        {title:'Five Nights at Freddys 4',src:'https://huffine.github.io/games/FNAF/4.html'},
        {title:'FNAF Sister Location',src:'https://huffine.github.io/games/FNAF/sisterlocation.html'},
        {title:'R.E.P.O',src:'https://huffine.github.io/games/R.E.P.O/index.html'},
        {title:"That's Not My Neighbor",src:'https://huffine.github.io/games/Thats-Not-My-Neighbor/index.html'},
        {title:'The Deadseat',src:'https://huffine.github.io/games/The-Deadseat/index.html'},
        {title:'Snow Rider 3D',src:'https://huffine.github.io/games/SnowRider3D/Snow-Rider-3D.html'},
        {title:'UltraKill',src:'https://huffine.github.io/games/Ultrakill/index.html'},
        {title:'Undertale',src:'https://huffine.github.io/games/Undertale/index.html'},
        {title:'Unicycle Hero',src:'https://huffine.github.io/games/unicycle-hero/unicycle-hero.html'},
        {title:"Baldi's Basics",src:'https://huffine.github.io/games/Baldis-basics/index.html'},
        {title:'Fears to Fathom Home Alone',src:'https://huffine.github.io/games/home-alone/index.html'},
        {title:'Hotline Miami',src:'https://huffine.github.io/games/hotline-miami/index.html'},
        {title:'The Man In The Window',src:'https://huffine.github.io/games/the-man-in-the-window/index.html'},
        {title:'CupHead',src:'https://huffine.github.io/games/CupHead/index.html'},
        {title:'Slender',src:'https://huffine.github.io/games/Slender/index.html'},
        {title:'Alien Hominid',src:'https://huffine.github.io/games/alien-hominid/Alien%20Hominid.html'},
        {title:'Angry Birds',src:'https://huffine.github.io/games/angry-birds/Angry%20Birds.html'},
        {title:'Backrooms',src:'https://huffine.github.io/games/backrooms/Backrooms.html'},
        {title:'Basket Random',src:'https://huffine.github.io/games/basket-random/Basket%20Random.html'},
        {title:'Bloons TD 4',src:'https://huffine.github.io/games/bloons-td4/Bloons%20TD%204.html'},
        {title:'Bloons TD 6',src:'https://huffine.github.io/games/bloonstd6/btd6.html'},
        {title:'Bloxorz',src:'https://huffine.github.io/games/bloxorz/Bloxorz.html'},
        {title:'Burrito Bison',src:'https://huffine.github.io/games/burito-bison/Burrito%20Bison.html'},
        {title:'Candy Crush',src:'https://huffine.github.io/games/candy-crush/Candy%20Crush.html'},
        {title:'Chess Classic',src:'https://huffine.github.io/games/chess-classic/Chess%20Classic.html'},
        {title:'City Smash',src:'https://huffine.github.io/games/city-smash/City%20Smash.html'},
        {title:'Cluster Truck',src:'https://huffine.github.io/games/cluster-truck/Cluster%20Rush.html'},
        {title:'Cookie Clicker',src:'https://huffine.github.io/games/cookie-clicker/Cookie%20Clicker.html'},
        {title:'Crazy Cattle 3D',src:'https://huffine.github.io/games/crazy-cattle-3d/Crazy%20Cattle%203D.html'},
        {title:'Crossy Road',src:'https://huffine.github.io/games/crossy-road/Crossy%20Road.html'},
        {title:'Cut the Rope',src:'https://huffine.github.io/games/cut-the-rope/Cut%20the%20Rope.html'},
        {title:'Deltarune',src:'https://huffine.github.io/games/deltarune/Deltarune.html'},
        {title:'Flappy Bird',src:'https://huffine.github.io/games/flappy-bird/Flappy%20Bird.html'},
        {title:'Fruit Ninja',src:'https://huffine.github.io/games/fruit-ninja/Fruit%20Ninja.html'},
        {title:'Geometry Dash',src:'https://huffine.github.io/games/geometry-dash/Geometry%20Dash%20Lite.html'},
        {title:'Google Baseball',src:'https://huffine.github.io/games/google-baseball/Google%20Baseball.html'},
        {title:'Granny',src:'https://huffine.github.io/games/granny/Granny.html'},
        {title:'Granny 2',src:'https://huffine.github.io/games/granny-2/Granny.html%202'},
        {title:'Granny 3',src:'https://huffine.github.io/games/granny-3/Granny.html%203'},
        {title:'Half Life',src:'https://huffine.github.io/games/halflife/Half%20Life.html'},
        {title:'Idle Breakout',src:'https://huffine.github.io/games/idle-breakout/Idle%20Breakout.html'},
        {title:'Jetpack Joyride',src:'https://huffine.github.io/games/jetpack-joyride/Jetpack%20Joyride.html'},
        {title:'Magic Tiles 3',src:'https://huffine.github.io/games/magic-tiles-3/Magic%20Tiles%203.html'},
        {title:'Paper.io 2',src:'https://huffine.github.io/games/paper.io2/Paper.io%202.html'},
        {title:'Plants vs Zombies',src:'https://huffine.github.io/games/plantsvszombies/Plants%20vs%20Zombies.html'},
        {title:'Retro Bowl College',src:'https://huffine.github.io/games/retro-bowl-college/Retro%20Bowl%20College.html'},
        {title:'Retro Bowl',src:'https://huffine.github.io/games/retro-bowl/Retro%20Bowl.html'},
        {title:'Run 3',src:'https://huffine.github.io/games/run3/Run%203.html'},
        {title:'Solar Smash',src:'https://huffine.github.io/games/solar-smash/Solar%20Smash.html'},
        {title:'Slope',src:'https://huffine.github.io/games/Slope/Slope.html'},
        {title:'Slope 2',src:'https://huffine.github.io/games/Slope/Slope%202.html'},
        {title:'Speed Stars',src:'https://huffine.github.io/games/speed-stars/Speed%20Stars.html'},
        {title:'Station Saturn',src:'https://huffine.github.io/games/station-saturn/Station%20Saturn.html'},
        {title:'Subway Surfers',src:'https://huffine.github.io/games/subway-surfers/Subway%20Surfers_%20Miami.html'},
        {title:'Superhot',src:'https://huffine.github.io/games/superhot/Superhot.html'},
        {title:'Temple Run 2',src:'https://huffine.github.io/games/templerun2/Temple%20Run%202.html'},
        {title:'Vex 7',src:'https://huffine.github.io/games/vex7/Vex%207.html'},
        {title:'Drift Hunters',src:'https://huffine.github.io/games/drift-hunters/drift-hunters.html'},
        {title:"Pretend It's Not There",src:'https://huffine.github.io/games/pint/pretenditsnotthere.html'},
        {title:'Slither.io',src:'https://huffine.github.io/games/slither/sfge.html'},
        {title:'Happy Wheels',src:'https://huffine.github.io/games/happywheels/happywheelss.html'},
        {title:'Kindergarten',src:'https://huffine.github.io/games/kindergarten/index.html'},
        {title:'Kindergarten 2',src:'https://huffine.github.io/games/kindergarten%202/index.html'},
        {title:'Kindergarten 3',src:'https://huffine.github.io/games/kindergarten%203/Kindergarten3.html'},
        {title:'MOTO X3M',src:'https://huffine.github.io/games/motox3m/motox3m.html'},
        {title:'2048',src:'https://huffine.github.io/games/2048/2048.html'},
        {title:'8 Ball Pool',src:'https://huffine.github.io/games/8-ball-pool/8%20Ball%20Pool.html'},
        {title:'3D Bowling',src:'https://huffine.github.io/games/3d-bowling/3D%20Bowling.html'},
      ];
      games.forEach(g=>{
        const id=crypto.randomUUID?.()||String(Date.now()+Math.random());
        items.push({id,title:g.title,src:g.src,tag:''});
      });
      Store.saveItems(items);
      render();
    }

    /* ============================================================
       Wire all controls
       ============================================================ */
    function wireAll(){
      const urlInput=qs('#gameUrl');
      qs('#addBtn').addEventListener('click',()=>addItem(urlInput.value));
      urlInput.addEventListener('keydown',e=>{ if(e.key==='Enter') addItem(urlInput.value); });

      qs('#layoutBtn').addEventListener('click',()=>{ layoutMode=layoutMode===3?2:layoutMode===2?1:3; applyLayout(); toast(layoutMode===3?'3-up grid':layoutMode===2?'2-up grid':'Full-width'); });
      qs('#bgBtn').addEventListener('click',()=>{ qs('#panel').hidden=!qs('#panel').hidden; });

      /* Manage modal */
      const manageModal=qs('#manageModal');
      qs('#manageBtn').addEventListener('click',()=>manageModal.classList.add('show'));
      qs('#bulkClose').addEventListener('click',()=>manageModal.classList.remove('show'));
      manageModal.addEventListener('click',e=>{ if(e.target===manageModal) manageModal.classList.remove('show'); });
      qs('#bulkAdd').addEventListener('click',()=>{
        const tag=qs('#tagInput').value.trim(), rename=qs('#renameInput').value.trim();
        const lines=qs('#bulkInput').value.split(/[\s\n]+/).map(s=>s.trim()).filter(Boolean);
        let n=0;
        lines.forEach(u=>{ const c=normalizeUrl(u); if(c){ items.unshift({id:crypto.randomUUID?.()||String(Date.now()+Math.random()),title:rename||deriveTitle(c),src:c,tag}); n++; }});
        Store.saveItems(items); render(); toast('Added '+n+' game(s)');
        qs('#bulkInput').value=''; qs('#renameInput').value=''; qs('#tagInput').value='';
      });

      /* Stats modal */
      const statsModal=qs('#statsModal');
      qs('#statsBtn').addEventListener('click',()=>{ updateStats(); statsModal.classList.add('show'); });
      qs('#statsClose').addEventListener('click',()=>statsModal.classList.remove('show'));
      statsModal.addEventListener('click',e=>{ if(e.target===statsModal) statsModal.classList.remove('show'); });

      /* Toolbar */
      qs('#seedDemo').addEventListener('click',seedDemos);
      qs('#shuffle').addEventListener('click',()=>{ items.sort(()=>Math.random()-.5); Store.saveItems(items); render(); toast('Shuffled!'); });
      qs('#sortAZ').addEventListener('click',()=>{ items.sort((a,b)=>a.title.localeCompare(b.title)); Store.saveItems(items); render(); toast('A‚ÄìZ'); });
      qs('#sortZA').addEventListener('click',()=>{ items.sort((a,b)=>b.title.localeCompare(a.title)); Store.saveItems(items); render(); toast('Z‚ÄìA'); });
      qs('#exportBtn').addEventListener('click',()=>{
        const d=JSON.stringify(items,null,2);
        navigator.clipboard?.writeText(d).then(()=>toast('Exported!')).catch(()=>{ prompt('Copy JSON:',d); });
      });
      qs('#importBtn').addEventListener('click',()=>{
        const d=prompt('Paste JSON:'); if(!d) return;
        try{
          const arr=JSON.parse(d); if(!Array.isArray(arr)) throw 0;
          items=arr.map(x=>({id:x.id||crypto.randomUUID?.()||String(Date.now()),title:x.title||deriveTitle(x.src||''),src:normalizeUrl(x.src)||'',tag:x.tag||''})).filter(x=>x.src);
          Store.saveItems(items); render(); toast('Imported '+items.length+' item(s)');
        }catch(e){ toast('‚ö† Invalid JSON'); }
      });
      qs('#selectAll').addEventListener('click',()=>{ selected=new Set(filtered().map(x=>x.id)); qsa('.card input[type="checkbox"]').forEach(cb=>cb.checked=true); updateSelectedCount(); });
      qs('#clearSelection').addEventListener('click',()=>{ selected.clear(); qsa('.card input[type="checkbox"]').forEach(cb=>cb.checked=false); updateSelectedCount(); });
      qs('#copyLinks').addEventListener('click',()=>{ const s=getSelectedItems(); if(!s.length){toast('Nothing selected');return;} navigator.clipboard?.writeText(s.map(x=>x.src).join('\n')).then(()=>toast('Copied '+s.length+' link(s)')); });
      qs('#openSelectedTabs').addEventListener('click',()=>openInTabs(getSelectedItems()));
      qs('#openSelectedBlanker').addEventListener('click',()=>openInBlanker(getSelectedItems(),false));
      qs('#openSelectedBlankerFS').addEventListener('click',()=>openInBlanker(getSelectedItems(),true));
      qs('#openSelectedTabs2').addEventListener('click',()=>openInTabs(getSelectedItems()));
      qs('#openSelectedBlanker2').addEventListener('click',()=>openInBlanker(getSelectedItems(),false));
      qs('#openSelectedBlankerFS2').addEventListener('click',()=>openInBlanker(getSelectedItems(),true));

      /* Filters */
      const filterMap={viewAll:'all',viewItch:'itch',viewSites:'sites',viewYT:'yt',viewOthers:'other'};
      Object.entries(filterMap).forEach(([id,mode])=>{
        qs('#'+id).addEventListener('click',e=>{ filterMode=mode; qsa('.nav .pill').forEach(p=>p.classList.remove('active')); e.currentTarget.classList.add('active'); render(); });
      });
      qs('#favoritesToggle').addEventListener('click',e=>{ showFavoritesOnly=!showFavoritesOnly; e.currentTarget.classList.toggle('active',showFavoritesOnly); render(); });

      /* Search */
      const searchBar=qs('#searchBar'), searchInput=qs('#searchInput');
      qs('#searchToggle').addEventListener('click',e=>{
        const open=searchBar.style.display==='none'||!searchBar.style.display;
        searchBar.style.display=open?'flex':'none';
        e.currentTarget.classList.toggle('active',open);
        if(open) searchInput.focus();
      });
      searchInput.addEventListener('input',()=>{ query=searchInput.value; render(); });
      qs('#searchClear').addEventListener('click',()=>{ query=''; searchInput.value=''; render(); });

      /* Background panel */
      const syncPrefs=()=>{
        qs('#bgStyle').value=prefs.style; qs('#bgAngle').value=prefs.angle;
        qs('#accentColor').value=prefs.accent; qs('#accent2Color').value=prefs.accent2; qs('#accent3Color').value=prefs.accent3;
        qs('#sat').value=prefs.sat; qs('#contrast').value=prefs.contrast; qs('#parallaxDepth').value=prefs.parallax;
        qs('#toggleParticles').checked=prefs.particles; qs('#toggleBlobs').checked=prefs.blobs;
      };
      syncPrefs();
      const pbind=(id,key,parse)=> qs(id).addEventListener('input',e=>{ prefs[key]=parse?parse(e.target.value):e.target.value; applyPrefs(); Store.savePrefs(prefs); });
      pbind('#bgStyle','style'); pbind('#bgAngle','angle',Number); pbind('#accentColor','accent'); pbind('#accent2Color','accent2'); pbind('#accent3Color','accent3');
      pbind('#sat','sat',Number); pbind('#contrast','contrast',Number); pbind('#parallaxDepth','parallax',Number);
      qs('#toggleParticles').addEventListener('change',e=>{ prefs.particles=e.target.checked; applyPrefs(); Store.savePrefs(prefs); });
      qs('#toggleBlobs').addEventListener('change',e=>{ prefs.blobs=e.target.checked; applyPrefs(); Store.savePrefs(prefs); });
      qs('#bgReset').addEventListener('click',()=>{ prefs=Object.assign({},prefsDefault); applyPrefs(); Store.savePrefs(prefs); syncPrefs(); toast('Background reset'); });
      qs('#bgClose').addEventListener('click',()=>{ qs('#panel').hidden=true; });

      /* Keyboard shortcuts */
      document.addEventListener('keydown',e=>{
        if(e.target.tagName==='INPUT'||e.target.tagName==='TEXTAREA') return;
        const k=e.key.toLowerCase();
        if(k==='l') qs('#layoutBtn').click();
        else if(k==='f'){ const c=qs('.card'); if(c) toggleFullscreen(c); }
        else if(k==='c'){ selected.clear(); qsa('.card input[type="checkbox"]').forEach(cb=>cb.checked=false); updateSelectedCount(); toast('Selection cleared'); }
        else if(k==='escape'){ qs('#manageModal').classList.remove('show'); qs('#statsModal').classList.remove('show'); if(!qs('#panel').hidden) qs('#panel').hidden=true; }
      });
    }

    /* Init */
    document.addEventListener('DOMContentLoaded',()=>{
      applyPrefs();
      render();
      wireAll();
      initParticles();
      initParallax();
      if(!items.length){ seedDemos(); }
    });
  })();
  </script>
<script>
/**
 * ============================================================
 *  DEEP BLUE GAMES HUB ‚Äî Save Progress Module v2
 *
 *  Add ONE line to index.html just before </body>:
 *    (load save-progress.js here)
 *
 *  FEATURES:
 *  1. CONSOLE INTERCEPT  ‚Äî saves all console.log/warn/error
 *  2. BLANKER CAPTURE    ‚Äî injects into about:blanker tabs,
 *                          auto-snapshots ALL localStorage
 *                          from inside the game window on
 *                          page unload + manual "Snap" button
 *  3. BOOKMARKLET        ‚Äî drag to bookmarks bar, click on
 *                          any game site to beam its full
 *                          localStorage back to the launcher
 *  4. NOTES              ‚Äî per-game manual progress notes
 *  5. EXPORT / IMPORT    ‚Äî full JSON backup & restore
 * ============================================================
 */
;(function SaveProgressModule() {
  "use strict";

  /* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
     STORAGE KEYS
  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
  const K_CONSOLE = "dbg_console_v2";
  const K_NOTES   = "dbg_notes_v2";
  const K_SNAPS   = "dbg_lssnaps_v2";
  const K_INJECT  = "dbg_inject_v2";
  const MAX_LOGS  = 500;

  /* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
     HELPERS
  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
  const store = {
    get(k, fb) { try { return JSON.parse(localStorage.getItem(k)) ?? fb; } catch { return fb; } },
    set(k, v)  { try { localStorage.setItem(k, JSON.stringify(v)); } catch(e) {} }
  };
  const esc = s => String(s).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;");
  function dlJSON(name, data) {
    const a = document.createElement("a");
    a.href = URL.createObjectURL(new Blob([JSON.stringify(data,null,2)],{type:"application/json"}));
    a.download = name; a.click();
    setTimeout(() => URL.revokeObjectURL(a.href), 3000);
  }
  function stamp() { return new Date().toLocaleString(); }

  /* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
     STATE
  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
  const consoleLogs = store.get(K_CONSOLE, []);
  const notesStore  = store.get(K_NOTES,   {});
  const lsSnaps     = store.get(K_SNAPS,   {});
  let   injectOn    = store.get(K_INJECT,  false);
  let   activeTab   = "console";
  let   conFilter   = "";
  let   panelOpen   = false;

  /* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
     CONSOLE INTERCEPT
  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
  const _orig = {};
  ["log","warn","error","info","debug"].forEach(m => {
    _orig[m] = console[m].bind(console);
    console[m] = (...args) => {
      _orig[m](...args);
      pushLog(m, args.map(a => { try { return typeof a==="object"?JSON.stringify(a):String(a); }catch{return String(a);} }).join(" "));
    };
  });

  function pushLog(lvl, msg, label) {
    const entry = { t: Date.now(), lvl, msg: label ? `[${label}] ${msg}` : msg };
    consoleLogs.push(entry);
    if (consoleLogs.length > MAX_LOGS) consoleLogs.splice(0, consoleLogs.length - MAX_LOGS);
    store.set(K_CONSOLE, consoleLogs);
    if (activeTab==="console" && panelOpen) {
      renderConsoleLogs();
      const list = document.getElementById("sp-con-list");
      if(list) list.scrollTop = list.scrollHeight;
    }
  }

  /* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
     SNAPSHOT RECEIVER
  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
  function receiveSnap(title, origin, snap) {
    const snapKeys = Object.keys(snap||{});
    if (!snapKeys.length) return;
    // Use origin as dedupe key so the same site overwrites rather than duplicates
    const key = (origin||title||"unknown").replace(/[^a-z0-9]/gi,"_").slice(0,40);
    lsSnaps[key] = { title: title||origin, origin, snap, savedAt: Date.now() };
    store.set(K_SNAPS, lsSnaps);
    if (activeTab==="saves" && panelOpen) renderSnaps();
    // Flash FAB badge
    document.getElementById("sp-badge").classList.add("on");
    setTimeout(() => document.getElementById("sp-badge").classList.remove("on"), 4000);
    pushLog("info", `Snapshot from "${title||origin}": ${snapKeys.length} key(s) captured`);
  }

  /* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
     MESSAGE BUS (BroadcastChannel + postMessage)
  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
  function handleMsg(raw) {
    try {
      const data = typeof raw==="string" ? JSON.parse(raw) : raw;
      if (!data || typeof data!=="object") return;
      if (data.type==="sp_snapshot") receiveSnap(data.title, data.origin, data.snap);
      if (data.type==="sp_log")      pushLog(data.lvl||"log", data.msg, data.label);
    } catch(e) {}
  }
  try { const bc = new BroadcastChannel("sp_channel"); bc.onmessage = e => handleMsg(e.data); } catch(e) {}
  window.addEventListener("message", e => handleMsg(e.data));

  /* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
     STYLES
  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
  document.head.insertAdjacentHTML("beforeend", `<style>
    #sp-fab{position:fixed;bottom:72px;right:18px;z-index:9999;width:50px;height:50px;border-radius:50%;
      background:linear-gradient(135deg,#67d1ff,#7fffd4);border:none;cursor:pointer;
      box-shadow:0 6px 22px rgba(103,209,255,.5);display:flex;align-items:center;justify-content:center;
      font-size:22px;transition:transform .2s,box-shadow .2s;color:#041224;font-family:inherit;}
    #sp-fab:hover{transform:scale(1.12) rotate(-8deg);box-shadow:0 10px 30px rgba(103,209,255,.65);}
    #sp-badge{position:absolute;top:-2px;right:-2px;width:13px;height:13px;border-radius:50%;
      background:#ff6e7a;display:none;border:2px solid #061024;animation:sp-pulse 1s ease infinite;}
    #sp-badge.on{display:block;}
    @keyframes sp-pulse{0%,100%{transform:scale(1);}50%{transform:scale(1.3);}}

    #sp-panel{position:fixed;bottom:134px;right:18px;z-index:9998;width:440px;
      max-width:calc(100vw - 24px);max-height:74vh;display:flex;flex-direction:column;
      background:rgba(5,11,28,.97);backdrop-filter:blur(20px);
      border:1px solid rgba(103,209,255,.22);border-radius:18px;
      box-shadow:0 32px 80px rgba(0,0,0,.75);font-family:'Comfortaa',system-ui,sans-serif;
      color:#e7f0ff;overflow:hidden;transition:opacity .22s,transform .22s;}
    #sp-panel.sp-hidden{opacity:0;pointer-events:none;transform:translateY(14px) scale(.96);}

    .sp-hdr{display:flex;align-items:center;justify-content:space-between;
      padding:12px 14px 0;flex-shrink:0;}
    .sp-hdr-title{font-size:.88rem;font-weight:700;color:#67d1ff;}
    .sp-hdr-close{width:26px;height:26px;border-radius:8px;border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.08);cursor:pointer;color:#e7f0ff;
      display:grid;place-items:center;font-size:13px;transition:.15s;}
    .sp-hdr-close:hover{background:rgba(255,110,122,.25);border-color:#ff6e7a;}

    .sp-tabs{display:flex;border-bottom:1px solid rgba(255,255,255,.09);
      background:rgba(255,255,255,.03);flex-shrink:0;margin-top:8px;}
    .sp-tab{flex:1;padding:9px 3px;text-align:center;cursor:pointer;font-size:.72rem;
      font-weight:700;letter-spacing:.03em;border:none;background:none;
      color:rgba(185,199,255,.5);border-bottom:2px solid transparent;transition:.15s;font-family:inherit;}
    .sp-tab:hover{color:#e7f0ff;}
    .sp-tab.on{color:#67d1ff;border-bottom-color:#67d1ff;}

    .sp-body{flex:1;overflow-y:auto;padding:12px;min-height:0;}
    .sp-body::-webkit-scrollbar{width:5px;}
    .sp-body::-webkit-scrollbar-thumb{background:rgba(103,209,255,.28);border-radius:5px;}

    /* shared button */
    .sp-btn{display:inline-flex;align-items:center;gap:5px;padding:7px 12px;border-radius:10px;
      border:1px solid rgba(255,255,255,.14);background:rgba(255,255,255,.07);color:#e7f0ff;
      font-family:inherit;font-size:.78rem;cursor:pointer;transition:.15s;white-space:nowrap;}
    .sp-btn:hover{background:rgba(255,255,255,.15);transform:translateY(-1px);}
    .sp-btn.accent{background:linear-gradient(135deg,rgba(103,209,255,.18),rgba(127,255,212,.18));
      border-color:rgba(103,209,255,.4);color:#a8e8ff;}
    .sp-btn.danger{border-color:rgba(255,110,122,.3);color:#ffaaaf;}
    .sp-btn.danger:hover{background:rgba(255,110,122,.12);}

    /* toolbar row */
    .sp-row{display:flex;gap:5px;flex-wrap:wrap;margin-bottom:8px;}

    /* console */
    .sp-entry{font-family:'Courier New',monospace;font-size:.75rem;padding:3px 7px;
      border-radius:5px;margin-bottom:2px;border-left:2px solid transparent;
      word-break:break-all;animation:sp-in .1s ease both;}
    @keyframes sp-in{from{opacity:0;transform:translateY(2px);}to{opacity:1;}}
    .sp-ll-log  {border-color:rgba(185,199,255,.3);color:#c5d5ff;background:rgba(255,255,255,.025);}
    .sp-ll-info {border-color:#67d1ff;color:#a8e8ff;background:rgba(103,209,255,.055);}
    .sp-ll-warn {border-color:#ffd76e;color:#ffe9a0;background:rgba(255,215,110,.055);}
    .sp-ll-error{border-color:#ff6e7a;color:#ffaaaf;background:rgba(255,110,122,.055);}
    .sp-ll-debug{border-color:#b28aff;color:#d4bcff;background:rgba(178,138,255,.045);}
    .sp-lts{font-size:.66rem;opacity:.4;margin-right:4px;}

    /* toggle */
    .sp-trow{display:flex;align-items:center;gap:9px;margin:8px 0;}
    .sp-track{width:40px;height:22px;border-radius:999px;cursor:pointer;flex-shrink:0;
      background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.18);
      position:relative;transition:.18s;}
    .sp-track.on{background:linear-gradient(90deg,#67d1ff,#7fffd4);border-color:#67d1ff;}
    .sp-knob{position:absolute;top:3px;left:3px;width:14px;height:14px;border-radius:50%;
      background:#fff;transition:transform .18s;box-shadow:0 2px 5px rgba(0,0,0,.3);}
    .sp-track.on .sp-knob{transform:translateX(18px);}
    .sp-tlbl{font-size:.8rem;color:#e7f0ff;}

    /* snap cards */
    .sp-card{background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.1);
      border-radius:12px;padding:11px 13px;margin-bottom:9px;}
    .sp-card-title{font-weight:700;font-size:.84rem;color:#67d1ff;margin-bottom:2px;}
    .sp-card-meta{font-size:.7rem;color:rgba(185,199,255,.5);margin-bottom:8px;}
    .sp-keys{display:flex;flex-wrap:wrap;gap:4px;margin-bottom:8px;}
    .sp-key{font-family:'Courier New',monospace;font-size:.68rem;padding:2px 7px;border-radius:5px;
      background:rgba(103,209,255,.1);border:1px solid rgba(103,209,255,.2);color:#a8e8ff;
      cursor:pointer;transition:.13s;max-width:170px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
    .sp-key:hover{background:rgba(103,209,255,.22);}

    /* notes */
    .sp-select{width:100%;padding:8px 10px;border-radius:10px;
      background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.14);
      color:#e7f0ff;font-family:inherit;font-size:.84rem;outline:none;margin-bottom:8px;}
    .sp-select option{background:#0a183a;}
    .sp-ta{width:100%;min-height:130px;padding:9px 11px;border-radius:10px;
      background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);
      color:#e7f0ff;font-family:'Courier New',monospace;font-size:.8rem;
      resize:vertical;outline:none;line-height:1.55;transition:.15s;}
    .sp-ta:focus{border-color:rgba(103,209,255,.5);background:rgba(255,255,255,.09);}
    .sp-saved{font-size:.72rem;color:#7fffd4;min-height:15px;transition:opacity .4s;margin-top:3px;}
    .sp-saved.fade{opacity:0;}

    /* bookmarklet */
    .sp-bm-box{background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.1);
      border-radius:12px;padding:13px;margin-bottom:10px;}
    .sp-bm-desc{font-size:.8rem;color:rgba(185,199,255,.75);line-height:1.65;margin-bottom:10px;}
    .sp-bm-link{display:block;padding:10px 14px;border-radius:10px;text-align:center;
      background:linear-gradient(135deg,rgba(103,209,255,.22),rgba(127,255,212,.22));
      border:1px solid rgba(103,209,255,.42);color:#a8e8ff;font-weight:700;
      font-size:.84rem;cursor:grab;text-decoration:none;transition:.15s;word-break:break-all;}
    .sp-bm-link:hover{background:linear-gradient(135deg,rgba(103,209,255,.35),rgba(127,255,212,.35));}
    .sp-bm-note{font-size:.74rem;color:rgba(185,199,255,.5);line-height:1.55;margin-top:8px;}

    /* val modal */
    #sp-vmodal{position:fixed;inset:0;z-index:99999;background:rgba(0,0,0,.65);
      backdrop-filter:blur(8px);display:none;place-items:center;}
    #sp-vmodal.on{display:grid;}
    #sp-vbox{width:min(480px,calc(100vw - 24px));background:rgba(5,11,28,.98);
      border:1px solid rgba(103,209,255,.3);border-radius:16px;padding:18px;
      box-shadow:0 32px 72px rgba(0,0,0,.85);}
    #sp-vkey{font-family:'Courier New',monospace;font-size:.8rem;color:#67d1ff;
      margin-bottom:8px;word-break:break-all;}
    #sp-vcontent{width:100%;min-height:120px;padding:9px;border-radius:10px;
      background:rgba(255,255,255,.07);border:1px solid rgba(255,255,255,.12);
      color:#e7f0ff;font-family:'Courier New',monospace;font-size:.75rem;resize:vertical;outline:none;}

    .sp-divider{height:1px;background:rgba(255,255,255,.07);margin:8px 0;}
    .sp-stat{font-size:.74rem;color:rgba(185,199,255,.45);margin-top:6px;}
    .sp-empty{font-size:.82rem;color:rgba(185,199,255,.5);line-height:1.6;}
    .sp-empty strong{color:#67d1ff;}
  </style>`);

  /* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
     PANEL HTML
  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
  document.body.insertAdjacentHTML("beforeend", `
    <button id="sp-fab" title="Save Progress">üíæ<span id="sp-badge" style="position:absolute;top:-2px;right:-2px;width:13px;height:13px;border-radius:50%;background:#ff6e7a;display:none;border:2px solid #061024;"></span></button>

    <div id="sp-panel" class="sp-hidden">
      <div class="sp-hdr">
        <span class="sp-hdr-title">üíæ Save Progress</span>
        <button class="sp-hdr-close" id="sp-close">‚úï</button>
      </div>
      <div class="sp-tabs">
        <button class="sp-tab on" data-tab="console">üñ• Console</button>
        <button class="sp-tab" data-tab="saves">üíæ Saves</button>
        <button class="sp-tab" data-tab="notes">üìù Notes</button>
        <button class="sp-tab" data-tab="bookmarklet">üîñ Bookmark</button>
        <button class="sp-tab" data-tab="export">üì¶ Export</button>
      </div>

      <!-- CONSOLE -->
      <div class="sp-body" id="sp-body-console">
        <div class="sp-row">
          <button class="sp-btn" id="sp-con-clear">üóë Clear</button>
          <button class="sp-btn" data-filter="">All</button>
          <button class="sp-btn" data-filter="error">Errors</button>
          <button class="sp-btn" data-filter="warn">Warns</button>
          <button class="sp-btn" data-filter="info">Info</button>
        </div>
        <div class="sp-trow">
          <div class="sp-track" id="sp-inject-track"><div class="sp-knob"></div></div>
          <span class="sp-tlbl" id="sp-inject-lbl">Inject console into Blanker tabs</span>
        </div>
        <div id="sp-con-list"></div>
      </div>

      <!-- SAVES -->
      <div class="sp-body sp-hidden" id="sp-body-saves">
        <div id="sp-snaps"></div>
        <div id="sp-snaps-empty" class="sp-empty" style="display:none">
          No saves yet.<br>
          ‚Ä¢ Open a game with <strong>Blanker</strong> (with inject ON) and click <strong>üíæ Snap</strong><br>
          ‚Ä¢ Or use the <strong>Bookmarklet</strong> tab on any game site
        </div>
      </div>

      <!-- NOTES -->
      <div class="sp-body sp-hidden" id="sp-body-notes">
        <select class="sp-select" id="sp-note-sel"><option value="">‚Äî Pick a game ‚Äî</option></select>
        <textarea class="sp-ta" id="sp-note-ta" placeholder="Level, score, passwords, seeds, tips‚Ä¶" spellcheck="false"></textarea>
        <div class="sp-saved fade" id="sp-saved-ind">‚úì Auto-saved</div>
      </div>

      <!-- BOOKMARKLET -->
      <div class="sp-body sp-hidden" id="sp-body-bookmarklet">
        <div class="sp-bm-box">
          <div class="sp-bm-desc">
            <strong style="color:#67d1ff">Drag this to your bookmarks bar</strong>, then click it on any game website to snapshot its full <strong style="color:#7fffd4">localStorage</strong> and beam it back here instantly.
          </div>
          <a id="sp-bm-link" class="sp-bm-link" title="Drag me to your bookmarks bar">üì∏ Snapshot Game Save</a>
          <div class="sp-bm-note">
            How it works:<br>
            1. Drag the button above to your bookmarks bar<br>
            2. Go to any game in a regular tab<br>
            3. Click the bookmarklet ‚Äî data appears in <strong style="color:#7fffd4">Saves</strong><br>
            4. This launcher tab must be open to receive it
          </div>
        </div>
        <div class="sp-bm-box">
          <div class="sp-bm-desc" style="margin-bottom:6px"><strong style="color:#7fffd4">Or paste this in DevTools Console</strong> on any game site:</div>
          <textarea class="sp-ta" id="sp-bm-code" readonly style="min-height:54px;font-size:.68rem;" spellcheck="false"></textarea>
        </div>
      </div>

      <!-- EXPORT -->
      <div class="sp-body sp-hidden" id="sp-body-export">
        <div style="display:flex;flex-direction:column;gap:7px;">
          <button class="sp-btn accent" id="sp-dl-all">üì¶ Download full save (JSON)</button>
          <button class="sp-btn" id="sp-dl-snaps">üíæ Download localStorage snapshots</button>
          <button class="sp-btn" id="sp-dl-notes">üìù Download notes only</button>
          <button class="sp-btn" id="sp-dl-logs">üñ• Download console logs</button>
          <div class="sp-divider"></div>
          <button class="sp-btn" id="sp-import-btn">üì• Import save file</button>
          <input type="file" id="sp-import-file" accept=".json" style="display:none"/>
          <div class="sp-divider"></div>
          <button class="sp-btn danger" id="sp-clear-all">üóë Clear ALL saved data</button>
          <div class="sp-stat" id="sp-stat-line"></div>
        </div>
      </div>
    </div>

    <!-- Value inspector -->
    <div id="sp-vmodal">
      <div id="sp-vbox">
        <div id="sp-vkey"></div>
        <textarea id="sp-vcontent" readonly></textarea>
        <button class="sp-btn" id="sp-vclose" style="margin-top:8px;width:100%;justify-content:center;">Close</button>
      </div>
    </div>
  `);

  /* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
     OPEN / CLOSE
  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
  document.getElementById("sp-fab").addEventListener("click", () => {
    panelOpen = !panelOpen;
    document.getElementById("sp-panel").classList.toggle("sp-hidden", !panelOpen);
    if (panelOpen) refreshActiveTab();
  });
  document.getElementById("sp-close").addEventListener("click", () => {
    panelOpen = false; document.getElementById("sp-panel").classList.add("sp-hidden");
  });

  function refreshActiveTab() {
    if (activeTab==="console")     renderConsoleLogs();
    if (activeTab==="saves")       renderSnaps();
    if (activeTab==="notes")       populateNoteSelect();
    if (activeTab==="bookmarklet") buildBookmarklet();
    if (activeTab==="export")      updateStatLine();
  }

  /* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
     TABS
  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
  document.querySelectorAll(".sp-tab").forEach(tab => {
    tab.addEventListener("click", () => {
      activeTab = tab.dataset.tab;
      document.querySelectorAll(".sp-tab").forEach(t => t.classList.remove("on"));
      tab.classList.add("on");
      document.querySelectorAll(".sp-body").forEach(b => b.classList.add("sp-hidden"));
      document.getElementById("sp-body-" + activeTab).classList.remove("sp-hidden");
      refreshActiveTab();
    });
  });

  /* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
     CONSOLE TAB
  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
  function renderConsoleLogs() {
    const list = document.getElementById("sp-con-list");
    const logs = conFilter ? consoleLogs.filter(l=>l.lvl===conFilter) : consoleLogs;
    list.innerHTML = "";
    const frag = document.createDocumentFragment();
    logs.slice(-150).forEach(e => {
      const d = document.createElement("div");
      d.className = "sp-entry sp-ll-" + e.lvl;
      d.innerHTML = `<span class="sp-lts">${new Date(e.t).toLocaleTimeString()}</span>${esc(e.msg)}`;
      frag.appendChild(d);
    });
    list.appendChild(frag);
    list.scrollTop = list.scrollHeight;
  }

  document.getElementById("sp-con-clear").addEventListener("click", () => {
    consoleLogs.length = 0; store.set(K_CONSOLE, []); renderConsoleLogs();
  });
  document.querySelectorAll("[data-filter]").forEach(btn => {
    btn.addEventListener("click", () => { conFilter = btn.dataset.filter; renderConsoleLogs(); });
  });

  // Inject toggle
  const injTrack = document.getElementById("sp-inject-track");
  const injLbl   = document.getElementById("sp-inject-lbl");
  function syncInject() {
    injTrack.classList.toggle("on", injectOn);
    injLbl.textContent = injectOn ? "Injecting ‚Äî ON (next Blanker opens will have panel)" : "Inject console into Blanker tabs";
    store.set(K_INJECT, injectOn);
    patchBlanker();
  }
  syncInject();
  injTrack.addEventListener("click", () => { injectOn = !injectOn; syncInject(); });

  /* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
     SAVES TAB
  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
  function renderSnaps() {
    const container = document.getElementById("sp-snaps");
    const emptyEl   = document.getElementById("sp-snaps-empty");
    const keys = Object.keys(lsSnaps).sort((a,b) => (lsSnaps[b].savedAt||0)-(lsSnaps[a].savedAt||0));
    container.innerHTML = "";

    if (!keys.length) { emptyEl.style.display="block"; return; }
    emptyEl.style.display = "none";

    keys.forEach(gk => {
      const s = lsSnaps[gk];
      const snapKeys = Object.keys(s.snap||{});
      const card = document.createElement("div");
      card.className = "sp-card";

      const keysId = "spkeys-" + gk.replace(/[^a-z0-9]/gi,"");
      card.innerHTML = `
        <div class="sp-card-title">${esc(s.title||gk)}</div>
        <div class="sp-card-meta">${esc(s.origin||"")} &nbsp;¬∑&nbsp; ${snapKeys.length} key(s) &nbsp;¬∑&nbsp; ${s.savedAt ? new Date(s.savedAt).toLocaleString() : "?"}</div>
        <div class="sp-keys" id="${keysId}"></div>
        <div class="sp-row">
          <button class="sp-btn" data-dl="${gk}">üíæ Download</button>
          <button class="sp-btn danger" data-del="${gk}">‚úï Delete</button>
        </div>`;

      const keysEl = card.querySelector("#" + keysId);
      snapKeys.slice(0,24).forEach(k => {
        const tag = document.createElement("span");
        tag.className="sp-key"; tag.textContent=k; tag.title="Click to inspect";
        tag.addEventListener("click", () => showVal(k, s.snap[k]));
        keysEl.appendChild(tag);
      });
      if (snapKeys.length > 24) {
        const more = document.createElement("span");
        more.className="sp-key"; more.textContent = `+${snapKeys.length-24} more`;
        keysEl.appendChild(more);
      }

      card.querySelector("[data-dl]").addEventListener("click", () =>
        dlJSON(`save-${gk}-${Date.now()}.json`, s));
      card.querySelector("[data-del]").addEventListener("click", () => {
        if (confirm("Delete this save?")) { delete lsSnaps[gk]; store.set(K_SNAPS, lsSnaps); renderSnaps(); }
      });

      container.appendChild(card);
    });
  }

  function showVal(key, val) {
    document.getElementById("sp-vkey").textContent = key;
    let pretty = val;
    try { pretty = JSON.stringify(JSON.parse(String(val)), null, 2); } catch { pretty = String(val); }
    document.getElementById("sp-vcontent").value = pretty;
    document.getElementById("sp-vmodal").classList.add("on");
  }
  document.getElementById("sp-vclose").addEventListener("click", () => document.getElementById("sp-vmodal").classList.remove("on"));
  document.getElementById("sp-vmodal").addEventListener("click", e => { if(e.target===document.getElementById("sp-vmodal")) document.getElementById("sp-vmodal").classList.remove("on"); });

  /* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
     NOTES TAB
  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
  let curNoteKey = null, noteSaveTimer = null;

  function populateNoteSelect() {
    const sel = document.getElementById("sp-note-sel");
    const cur = sel.value;
    sel.innerHTML = `<option value="">‚Äî Pick a game ‚Äî</option>`;
    Object.keys(notesStore).forEach(k => {
      const o = document.createElement("option");
      o.value=k; o.textContent=notesStore[k].title||k; sel.appendChild(o);
    });
    try {
      JSON.parse(localStorage.getItem("dbg_items_v6")||"[]").forEach(item => {
        if (!notesStore[item.id]) {
          const o = document.createElement("option");
          o.value=item.id; o.textContent=item.title||item.src; sel.appendChild(o);
        }
      });
    } catch(e) {}
    Object.keys(lsSnaps).forEach(k => {
      if (!notesStore[k] && !document.querySelector(`#sp-note-sel option[value="${k}"]`)) {
        const o = document.createElement("option");
        o.value=k; o.textContent=lsSnaps[k].title||k; sel.appendChild(o);
      }
    });
    sel.value = cur;
    loadNote(sel.value);
  }

  function loadNote(key) {
    curNoteKey = key||null;
    const ta = document.getElementById("sp-note-ta");
    ta.disabled = !key;
    ta.value = key ? (notesStore[key]?.notes||"") : "";
  }

  document.getElementById("sp-note-sel").addEventListener("change", e => loadNote(e.target.value));
  document.getElementById("sp-note-ta").addEventListener("input", () => {
    if (!curNoteKey) return;
    const text = document.getElementById("sp-note-ta").value;
    if (!notesStore[curNoteKey]) {
      let title = curNoteKey;
      try { const f = JSON.parse(localStorage.getItem("dbg_items_v6")||"[]").find(x=>x.id===curNoteKey); if(f) title=f.title||title; } catch(e) {}
      notesStore[curNoteKey] = { title, notes:"", ts:0 };
    }
    notesStore[curNoteKey].notes = text;
    notesStore[curNoteKey].ts = Date.now();
    clearTimeout(noteSaveTimer);
    noteSaveTimer = setTimeout(() => {
      store.set(K_NOTES, notesStore);
      const ind = document.getElementById("sp-saved-ind");
      ind.classList.remove("fade");
      setTimeout(() => ind.classList.add("fade"), 1400);
    }, 500);
  });

  /* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
     BOOKMARKLET TAB
  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
  function buildBookmarklet() {
    const code = `(function(){var s={};for(var i=0;i<localStorage.length;i++){var k=localStorage.key(i);s[k]=localStorage.getItem(k);}var p=JSON.stringify({type:'sp_snapshot',title:document.title,origin:location.origin,snap:s});try{new BroadcastChannel('sp_channel').postMessage(p);}catch(e){}try{window.opener&&window.opener.postMessage(p,'*');}catch(e){}alert('Snapshot sent! '+Object.keys(s).length+' keys from '+location.origin);})();`;
    document.getElementById("sp-bm-link").href = "javascript:" + encodeURIComponent(code);
    document.getElementById("sp-bm-code").value = code;
  }

  /* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
     EXPORT TAB
  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
  function updateStatLine() {
    document.getElementById("sp-stat-line").textContent =
      `${Object.keys(lsSnaps).length} save snapshot(s) ¬∑ ${Object.keys(notesStore).length} note(s) ¬∑ ${consoleLogs.length} log(s)`;
  }

  document.getElementById("sp-dl-all").addEventListener("click", () =>
    dlJSON(`dbg-save-${Date.now()}.json`, { exported:new Date().toISOString(), version:2, lsSnaps, notes:notesStore, consoleLogs }));
  document.getElementById("sp-dl-snaps").addEventListener("click", () => dlJSON(`dbg-snaps-${Date.now()}.json`, lsSnaps));
  document.getElementById("sp-dl-notes").addEventListener("click", () => dlJSON(`dbg-notes-${Date.now()}.json`, notesStore));
  document.getElementById("sp-dl-logs").addEventListener("click",  () => dlJSON(`dbg-logs-${Date.now()}.json`, consoleLogs));
  document.getElementById("sp-import-btn").addEventListener("click", () => document.getElementById("sp-import-file").click());
  document.getElementById("sp-import-file").addEventListener("change", e => {
    const file = e.target.files[0]; if (!file) return;
    const r = new FileReader();
    r.onload = ev => {
      try {
        const d = JSON.parse(ev.target.result);
        if (d.lsSnaps)     Object.assign(lsSnaps, d.lsSnaps);
        if (d.notes)       Object.assign(notesStore, d.notes);
        if (d.consoleLogs) { consoleLogs.length=0; consoleLogs.push(...d.consoleLogs); }
        store.set(K_SNAPS, lsSnaps); store.set(K_NOTES, notesStore); store.set(K_CONSOLE, consoleLogs);
        refreshActiveTab(); updateStatLine();
        alert("‚úì Import successful!");
      } catch { alert("‚ö† Invalid save file"); }
    };
    r.readAsText(file); e.target.value="";
  });
  document.getElementById("sp-clear-all").addEventListener("click", () => {
    if (!confirm("Delete ALL snapshots, notes, and console logs? Cannot be undone.")) return;
    consoleLogs.length=0;
    Object.keys(notesStore).forEach(k=>delete notesStore[k]);
    Object.keys(lsSnaps).forEach(k=>delete lsSnaps[k]);
    store.set(K_CONSOLE,[]); store.set(K_NOTES,{}); store.set(K_SNAPS,{});
    refreshActiveTab(); updateStatLine(); alert("Cleared.");
  });

  /* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
     BLANKER PATCH
     Wraps makeBlankerHTML() to inject a floating
     save panel + console + localStorage snap button
     into every about:blanker game window.
  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
  function patchBlanker() {
    if (!injectOn) {
      if (window.__sp_orig) window.makeBlankerHTML = window.__sp_orig;
      return;
    }
    if (!window.__sp_orig) {
      if (typeof window.makeBlankerHTML !== "function") { setTimeout(patchBlanker, 300); return; }
      window.__sp_orig = window.makeBlankerHTML;
    }

    window.makeBlankerHTML = function(title, src, autoFS) {
      const base = window.__sp_orig(title, src, autoFS);
      const safeTitle = JSON.stringify(String(title||"Game"));
      const safeOrigin = JSON.stringify(String(src||""));

      const inject = `
<style>
  #spw{position:fixed;bottom:10px;right:10px;z-index:99999;width:290px;
    background:rgba(4,9,24,.96);border:1px solid rgba(103,209,255,.28);border-radius:12px;
    font-size:.72rem;color:#c5d5ff;box-shadow:0 14px 44px rgba(0,0,0,.8);overflow:hidden;
    transition:max-height .22s ease;max-height:280px;font-family:'Courier New',monospace;}
  #spw.col{max-height:34px;}
  #spwh{display:flex;align-items:center;justify-content:space-between;padding:6px 8px;
    background:rgba(103,209,255,.07);cursor:pointer;border-bottom:1px solid rgba(255,255,255,.06);}
  #spwt{font-weight:700;color:#67d1ff;font-family:system-ui,sans-serif;font-size:.74rem;
    overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:150px;}
  .spwb{padding:3px 7px;border-radius:5px;border:1px solid rgba(255,255,255,.12);
    background:rgba(255,255,255,.07);color:#e7f0ff;cursor:pointer;font-size:.67rem;margin-left:2px;}
  .spwb:hover{background:rgba(255,255,255,.18);}
  #spwlogs{overflow-y:auto;max-height:130px;padding:4px 7px;}
  #spwlogs::-webkit-scrollbar{width:3px;}
  #spwlogs::-webkit-scrollbar-thumb{background:rgba(103,209,255,.3);border-radius:3px;}
  .spwl{padding:2px 0 2px 5px;border-left:2px solid rgba(255,255,255,.14);margin-bottom:1px;word-break:break-all;}
  .spwl.e{border-color:#ff6e7a;color:#ffaaaf;} .spwl.w{border-color:#ffd76e;color:#ffe9a0;}
  .spwl.i{border-color:#67d1ff;color:#a8e8ff;}
  #spwnotes{padding:6px 8px;border-top:1px solid rgba(255,255,255,.06);display:none;}
  #spwna{width:100%;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.1);
    border-radius:6px;color:#e7f0ff;font-family:'Courier New',monospace;font-size:.68rem;
    padding:4px;resize:none;outline:none;height:42px;}
  #spwna:focus{border-color:rgba(103,209,255,.45);}
  #spwsnapinfo{padding:5px 8px;border-top:1px solid rgba(255,255,255,.06);
    font-size:.68rem;color:#7fffd4;display:none;}
</style>
<div id="spw">
  <div id="spwh">
    <span id="spwt">üíæ Console</span>
    <span>
      <button class="spwb" id="spwn">üìù</button>
      <button class="spwb" id="spwsnap">üíæ Snap</button>
      <button class="spwb" id="spwcl">‚Äî</button>
    </span>
  </div>
  <div id="spwlogs"></div>
  <div id="spwnotes">
    <textarea id="spwna" placeholder="Progress notes‚Ä¶"></textarea>
    <div style="display:flex;gap:4px;margin-top:3px;">
      <button class="spwb" id="spwsb">Save</button>
      <button class="spwb" id="spwclear">Clear logs</button>
    </div>
  </div>
  <div id="spwsnapinfo"></div>
</div>
<script>
(function(){
  var TITLE=${safeTitle};
  var NOTE_KEY='sp_note_'+encodeURIComponent(TITLE).slice(0,40);
  var logs=document.getElementById('spwlogs');
  var collapsed=false;

  function send(type,data){
    var p=JSON.stringify(Object.assign({type:type},data));
    try{new BroadcastChannel('sp_channel').postMessage(p);}catch(e){}
    try{window.opener&&window.opener.postMessage(p,'*');}catch(e){}
  }

  function addLog(lvl,msg){
    var d=document.createElement('div');
    d.className='spwl '+(lvl==='error'?'e':lvl==='warn'?'w':lvl==='info'?'i':'');
    d.textContent=new Date().toLocaleTimeString().slice(0,8)+' '+msg.slice(0,200);
    logs.appendChild(d);
    if(logs.children.length>80) logs.removeChild(logs.firstChild);
    logs.scrollTop=logs.scrollHeight;
    send('sp_log',{lvl:lvl,msg:msg,label:TITLE});
  }

  // Console intercept
  ['log','warn','error','info','debug'].forEach(function(m){
    var o=console[m].bind(console);
    console[m]=function(){
      o.apply(console,arguments);
      addLog(m,Array.from(arguments).map(function(a){
        try{return typeof a==='object'?JSON.stringify(a):String(a);}catch(e){return String(a);}
      }).join(' '));
    };
  });
  window.addEventListener('error',function(e){addLog('error','Uncaught: '+e.message+' (line '+e.lineno+')');});
  window.addEventListener('unhandledrejection',function(e){addLog('error','Promise rejection: '+String(e.reason));});

  function snapLS(){
    var snap={};
    for(var i=0;i<localStorage.length;i++){var k=localStorage.key(i);snap[k]=localStorage.getItem(k);}
    send('sp_snapshot',{title:document.title||TITLE,origin:location.origin,snap:snap});
    return snap;
  }

  // Snap button
  document.getElementById('spwsnap').addEventListener('click',function(){
    var snap=snapLS();
    var info=document.getElementById('spwsnapinfo');
    var n=Object.keys(snap).length;
    info.style.display='block';
    info.textContent='‚úì '+n+' key(s) sent to launcher'+(n===0?' (localStorage is empty here ‚Äî game may use a different storage)':'');
    setTimeout(function(){info.style.display='none';},4000);
  });

  // Auto-snap on unload
  window.addEventListener('beforeunload',function(){
    var snap={};
    for(var i=0;i<localStorage.length;i++){var k=localStorage.key(i);snap[k]=localStorage.getItem(k);}
    if(Object.keys(snap).length) send('sp_snapshot',{title:document.title||TITLE,origin:location.origin,snap:snap});
  });

  // Collapse
  document.getElementById('spwh').addEventListener('click',function(e){
    if(e.target.closest('.spwb')) return;
    collapsed=!collapsed;
    document.getElementById('spw').classList.toggle('col',collapsed);
    document.getElementById('spwcl').textContent=collapsed?'+':'‚Äî';
  });
  document.getElementById('spwcl').addEventListener('click',function(e){
    e.stopPropagation();collapsed=!collapsed;
    document.getElementById('spw').classList.toggle('col',collapsed);
    e.target.textContent=collapsed?'+':'‚Äî';
  });

  // Notes
  document.getElementById('spwn').addEventListener('click',function(){
    var n=document.getElementById('spwnotes');
    var show=n.style.display==='none';
    n.style.display=show?'block':'none';
    if(show){document.getElementById('spwna').value=localStorage.getItem(NOTE_KEY)||'';}
  });
  document.getElementById('spwsb').addEventListener('click',function(){
    var txt=document.getElementById('spwna').value;
    localStorage.setItem(NOTE_KEY,txt);
    send('sp_note',{key:NOTE_KEY,txt:txt,gameTitle:TITLE});
    this.textContent='‚úì'; setTimeout(function(){document.getElementById('spwsb').textContent='Save';},1200);
  });
  document.getElementById('spwclear').addEventListener('click',function(){logs.innerHTML='';});

  addLog('info','Save Progress ready. Hit üíæ Snap to capture localStorage.');
})();
<\/script>`;

      return base.replace("</body>", inject + "</body>");
    };
  }

  patchBlanker();
  document.addEventListener("DOMContentLoaded", patchBlanker);

  console.log("[SaveProgress v2] ‚úì Loaded ‚Äî console intercepted, BroadcastChannel listening");
})();
</script>


<!-- AI Chat Modal -->
  <div id="aiModal" class="modal" style="z-index:95;">
    <div class="box" style="width:min(820px,calc(100vw - 20px));height:min(88vh,820px);display:flex;flex-direction:column;padding:0;overflow:hidden;">
      <!-- Modal Header -->
      <div style="display:flex;align-items:center;gap:12px;padding:16px 20px;background:rgba(255,255,255,.05);border-bottom:1px solid rgba(255,255,255,.1);flex-shrink:0;">
        <div style="width:36px;height:36px;border-radius:10px;background:conic-gradient(from 120deg,#67d1ff,#7fffd4,#b28aff,#174081,#67d1ff);animation:spinSoft 14s linear infinite;flex-shrink:0;"></div>
        <div>
          <div style="font-weight:700;font-size:1rem;color:var(--accent);">O&amp;B StarLauncher AI</div>
          <div style="font-size:.74rem;color:var(--muted);">Ask me anything about games, get recommendations, or chat!</div>
        </div>
        <div style="flex:1;"></div>
        <button id="aiClose" style="width:32px;height:32px;border-radius:9px;border:1px solid rgba(255,255,255,.16);background:rgba(255,255,255,.08);color:var(--text);cursor:pointer;font-size:16px;display:grid;place-items:center;">‚úï</button>
      </div>
      <!-- Messages area -->
      <div id="aiMessages" style="flex:1;overflow-y:auto;padding:18px;display:flex;flex-direction:column;gap:12px;scroll-behavior:smooth;">
        <div class="ai-msg ai-assistant" style="display:flex;gap:10px;align-items:flex-start;">
          <div class="ai-avatar"></div>
          <div class="ai-bubble">Hey! I'm your O&amp;B StarLauncher AI. I can help you pick games, explain what's in your library, or just chat. What's up?</div>
        </div>
      </div>
      <!-- Typing indicator -->
      <div id="aiTyping" style="display:none;padding:0 18px 8px;flex-shrink:0;">
        <div style="display:flex;gap:10px;align-items:center;">
          <div class="ai-avatar" style="flex-shrink:0;"></div>
          <div style="background:rgba(255,255,255,.07);border:1px solid rgba(255,255,255,.12);border-radius:16px 16px 16px 4px;padding:10px 14px;display:flex;gap:5px;align-items:center;">
            <div class="ai-dot"></div><div class="ai-dot" style="animation-delay:.2s;"></div><div class="ai-dot" style="animation-delay:.4s;"></div>
          </div>
        </div>
      </div>
      <!-- Input area -->
      <div style="padding:14px 16px;background:rgba(255,255,255,.04);border-top:1px solid rgba(255,255,255,.1);flex-shrink:0;display:flex;gap:10px;align-items:flex-end;">
        <textarea id="aiInput" placeholder="Ask me anything‚Ä¶ what should I play? Best horror games? How do I use Blanker?" style="flex:1;resize:none;min-height:44px;max-height:120px;padding:11px 14px;border-radius:14px;border:1px solid rgba(255,255,255,.18);background:rgba(255,255,255,.08);color:var(--text);font-family:inherit;font-size:.92rem;outline:none;line-height:1.5;overflow-y:auto;" rows="1"></textarea>
        <button id="aiSend" style="width:44px;height:44px;border-radius:12px;border:0;background:linear-gradient(135deg,var(--accent),var(--accent-2));color:#041224;font-size:18px;cursor:pointer;display:grid;place-items:center;flex-shrink:0;box-shadow:0 6px 18px rgba(103,209,255,.35);transition:.15s;" title="Send">‚û§</button>
      </div>
    </div>
  </div>

  <script>
  /* ============================================================
     AI CHAT ‚Äî powered by Claude API
     ============================================================ */
  document.addEventListener('DOMContentLoaded', function(){
  (function(){
    const aiModal   = document.getElementById('aiModal');
    const aiMessages= document.getElementById('aiMessages');
    const aiInput   = document.getElementById('aiInput');
    const aiSend    = document.getElementById('aiSend');
    const aiTyping  = document.getElementById('aiTyping');
    const aiClose   = document.getElementById('aiClose');
    const aiBtn     = document.getElementById('aiChatBtn');

    // Conversation history for context
    let history = [];

    function getGameContext(){
      try{
        const items = JSON.parse(localStorage.getItem('dbg_items_v6')||'[]');
        if(!items.length) return 'No games loaded yet.';
        return 'Games in library: ' + items.slice(0,30).map(x=>x.title).join(', ') + (items.length>30 ? ` ...and ${items.length-30} more.` : '');
      }catch(e){ return ''; }
    }

    // Open/close
    aiBtn.addEventListener('click', ()=>{
      aiModal.classList.add('show');
      aiInput.focus();
    });
    aiClose.addEventListener('click', ()=> aiModal.classList.remove('show'));
    aiModal.addEventListener('click', e=>{ if(e.target===aiModal) aiModal.classList.remove('show'); });

    // Auto-resize textarea
    aiInput.addEventListener('input', ()=>{
      aiInput.style.height='auto';
      aiInput.style.height = Math.min(aiInput.scrollHeight, 120) + 'px';
    });

    // Send on Enter (Shift+Enter = newline)
    aiInput.addEventListener('keydown', e=>{
      if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); sendMessage(); }
    });
    aiSend.addEventListener('click', sendMessage);

    function addMessage(role, text){
      const wrap = document.createElement('div');
      wrap.className = 'ai-msg ai-' + role;
      wrap.style.cssText = 'display:flex;gap:10px;align-items:flex-start;animation:floatIn .3s ease both;';

      const avatar = document.createElement('div');
      avatar.className = 'ai-avatar';

      const bubble = document.createElement('div');
      bubble.className = 'ai-bubble';
      // Simple markdown: **bold**, `code`, newlines
      bubble.innerHTML = text
        .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
        .replace(/\*\*(.+?)\*\*/g,'<strong>$1</strong>')
        .replace(/`([^`]+)`/g,'<code>$1</code>')
        .replace(/\n/g,'<br>');

      wrap.append(avatar, bubble);
      aiMessages.appendChild(wrap);
      aiMessages.scrollTop = aiMessages.scrollHeight;
      return bubble;
    }

    async function sendMessage(){
      const text = aiInput.value.trim();
      if(!text) return;

      aiInput.value = '';
      aiInput.style.height = 'auto';
      addMessage('user', text);

      history.push({ role:'user', content: text });

      // Show typing
      aiTyping.style.display = 'block';
      aiMessages.scrollTop = aiMessages.scrollHeight;
      aiSend.disabled = true;

      try{
        const systemPrompt = `You are the O&B StarLauncher AI assistant ‚Äî a friendly, enthusiastic gaming helper embedded in a game launcher website called "O&B StarLauncher". The launcher lets users play browser games, organize them, open games in a special "Blanker" window, save progress, and more.

Be helpful, fun, and concise. You can help users pick games, explain features, give gaming tips, or just chat about games. Keep responses reasonably short unless asked for detail. Use **bold** for emphasis and short paragraphs.

Current library context: ${getGameContext()}`;

        const response = await fetch('https://api.anthropic.com/v1/messages', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            model: 'claude-sonnet-4-20250514',
            max_tokens: 1000,
            system: systemPrompt,
            messages: history
          })
        });

        const data = await response.json();
        aiTyping.style.display = 'none';

        let reply = '';
        if(data.content && data.content[0]){
          reply = data.content[0].text || '';
        } else if(data.error){
          reply = '‚ö† API error: ' + (data.error.message || JSON.stringify(data.error));
        } else {
          reply = '‚ö† Unexpected response from API.';
        }

        history.push({ role:'assistant', content: reply });
        addMessage('assistant', reply);

      } catch(err){
        aiTyping.style.display = 'none';
        addMessage('assistant', '‚ö† Could not reach the AI. Make sure you have network access and try again. (' + err.message + ')');
      } finally {
        aiSend.disabled = false;
        aiInput.focus();
      }
    }
  })();
  }); // DOMContentLoaded
  </script>
</body>
</html>
